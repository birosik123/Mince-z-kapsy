<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mince z kapsy - Dark Mobile v2 (Barvy)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* === DARK THEME PALETTE === */
            --bg-app: #000000;
            --bg-card: #121212;
            --bg-subtle: #1e1e1e;
            --border-color: #333333;

            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #666666;

            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --warn: #f1e05a;
            --accent-purple: #a855f7;
            --accent-cyan: #06b6d4; /* New accent color */
            --accent-orange: #f97316; /* New accent color */
            
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.5);
            --shadow-floating: 0 10px 25px rgba(0,0,0,0.8);

            --header-height: 56px;
            --bottom-bar-height: 60px; 
            --radius-card: 16px;
            --radius-btn: 10px;
        }

        /* Reset & Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-app);
            color: var(--text-primary);
            font-size: 0.92rem;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- Toast Notifications --- */
        #toast-container { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; 
            width: auto; display: flex; flex-direction: column; gap: 10px; pointer-events: none; 
        }
        .toast { 
            background: var(--bg-card); color: var(--text-primary); padding: 16px 32px; 
            border-radius: 50px; border: 2px solid var(--accent-blue);
            box-shadow: 0 10px 40px rgba(0,0,0,1); opacity: 0; transform: translateY(20px) scale(0.9);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem; white-space: nowrap; 
        }
        .toast.show { opacity: 1; transform: translateY(0) scale(1); }
        .toast-icon { margin-right: 12px; font-size: 1.3rem; }

        /* --- Header & Navigation --- */
        .app-header {
            background: rgba(18, 18, 18, 0.95); backdrop-filter: blur(10px); height: var(--header-height);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; border-bottom: 1px solid var(--border-color);
            position: fixed; top: 0; left: 0; right: 0; z-index: 50;
        }
        .menu-toggle-btn { font-size: 1.4rem; cursor: pointer; padding: 8px; margin-left: -8px; color: var(--text-primary); }
        .app-title { font-size: 1.1rem; font-weight: 800; color: var(--text-primary); letter-spacing: -0.5px; }
        .app-title span { color: var(--accent-blue); }
        
        .header-add-btn {
            width: 36px; height: 36px; border-radius: 50%;
            background: var(--accent-blue); color: white;
            border: none; font-size: 1.5rem; font-weight: 400; line-height: 1;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s;
        }
        .header-add-btn:active { transform: scale(0.9); }

        /* Sidebar */
        .sidebar-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 90; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .sidebar-overlay.active { opacity: 1; visibility: visible; }
        .sidebar-menu {
            position: fixed; top: 0; left: -280px; width: 260px; height: 100%;
            background: var(--bg-card); z-index: 100; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; box-shadow: var(--shadow-floating); border-right: 1px solid var(--border-color);
        }
        .sidebar-menu.active { left: 0; }
        .sidebar-header { padding: 24px 20px; border-bottom: 1px solid var(--border-color); font-size: 1.2rem; font-weight: 800;}
        .sidebar-nav { padding: 16px 12px; flex: 1; }
        .nav-link { display: flex; align-items: center; padding: 14px; margin-bottom: 4px; text-decoration: none; color: var(--text-secondary); font-weight: 600; font-size: 0.95rem; border-radius: var(--radius-btn); transition: all 0.2s; }
        .nav-link-icon { margin-right: 12px; font-size: 1.2rem; opacity: 0.8; }
        .nav-link.active { background: var(--bg-subtle); color: var(--accent-blue); }
        .nav-link.active .nav-link-icon { opacity: 1; }


        /* --- Main Content Layout --- */
        .main-content { flex: 1; overflow-y: auto; padding: 16px 16px calc(var(--bottom-bar-height) + 60px) 16px; margin-top: var(--header-height); }
        .container { max-width: 768px; margin: 0 auto; }
        .view-section { display: none; }
        .view-section.active { display: block; }

        /* --- Cards & Typography --- */
        .card { background: var(--bg-card); padding: 20px; border-radius: var(--radius-card); box-shadow: var(--shadow-sm); margin-bottom: 16px; border: 1px solid var(--border-color); }
        h2 { font-size: 1.1rem; font-weight: 700; margin-bottom: 16px; color: var(--text-primary); }
        h3 { font-size: 1rem; font-weight: 600; margin-bottom: 12px; color: var(--text-primary); }
        h4 { font-size: 0.8rem; font-weight: 700; margin-bottom: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
        
        /* --- Forms & Inputs --- */
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        @media (min-width: 600px) { .form-grid.two-col { grid-template-columns: 1fr 1fr; } }
        .form-group { display: flex; flex-direction: column; }
        .form-label { font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary); }
        .form-input, .form-select {
            padding: 12px 14px; border: 1px solid var(--border-color); border-radius: 10px;
            font-size: 0.9rem; outline: none; transition: all 0.2s; background: var(--bg-subtle); width: 100%; color: var(--text-primary); font-weight: 500; font-family: 'Inter';
        }
        .form-input:focus, .form-select:focus { border-color: var(--accent-blue); background: var(--bg-subtle); }
        
        /* Chart Select - decentn√≠ rolovac√≠ select pro grafy */
        .chart-select {
            padding: 8px 12px;
            border: 1px solid rgba(51, 51, 51, 0.6);
            border-radius: 8px;
            font-size: 0.85rem;
            outline: none;
            transition: all 0.2s ease;
            background: rgba(30, 30, 30, 0.5);
            color: var(--text-secondary);
            font-weight: 500;
            font-family: 'Inter';
            cursor: pointer;
            min-width: 120px;
        }
        .chart-select:hover {
            border-color: rgba(59, 130, 246, 0.4);
            background: rgba(30, 30, 30, 0.8);
        }
        .chart-select:focus {
            border-color: var(--accent-blue);
            background: rgba(30, 30, 30, 0.9);
            color: var(--text-primary);
        }
        .chart-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }
        @media (min-width: 500px) {
            .chart-controls {
                justify-content: flex-start;
            }
        }

        /* --- Buttons --- */
        .btn { padding: 12px 20px; border: 1px solid var(--border-color); border-radius: var(--radius-btn); font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; text-align: center; font-family: 'Inter'; background: var(--bg-subtle); color: var(--text-primary); }
        .btn:hover { border-color: var(--accent-blue); }
        .btn:active { transform: scale(0.98); }
        .btn-sm { padding: 8px 14px; font-size: 0.85rem; }
        .btn-icon { padding: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 10px; background: var(--bg-subtle); color: var(--text-secondary); border: none; cursor: pointer;}
        .btn-icon:hover { background: var(--border-color); color: var(--text-primary); }
        
        .btn-primary { background: var(--accent-blue); color: white; border: none; }
        .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: var(--bg-subtle); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { border-color: var(--text-secondary); color: var(--text-primary); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--accent-red); border: 1px solid var(--accent-red); }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.2); }
        .btn-block { width: 100%; }

        /* SPODN√ç LI≈†TA */
        .bottom-app-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--bottom-bar-height);
            background: rgba(18, 18, 18, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 0 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }

        /* --- Lists --- */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .item-main { font-weight: 600; font-size: 0.95rem; color: var(--text-primary); }
        .item-sub { font-size: 0.8rem; color: var(--text-secondary); margin-top: 2px; }
        .amount { font-weight: 600; font-size: 0.95rem; }
        .amount.inc { color: var(--accent-green); } .amount.exp { color: var(--text-primary); }
        
        /* Loan Overview Card */
        .loan-overview-item { background: var(--bg-subtle); border: 1px solid var(--border-color); padding: 16px; border-radius: var(--radius-card); margin-bottom: 12px; cursor: pointer; }
        .loan-progress-bg { height: 6px; background: var(--bg-card); border-radius: 3px; overflow: hidden; margin: 12px 0; }
        .loan-progress-fill { height: 100%; background: var(--accent-blue); border-radius: 3px; }

        /* Loan Schedule Cards */
        .schedule-list-container { display: flex; flex-direction: column; gap: 8px; padding: 0 2px 20px 2px; align-items: center; }
        .schedule-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 10px 14px; display: flex; align-items: center; justify-content: space-between; width: 100%; max-width: 360px; transition: all 0.2s ease; }
        .schedule-card.is-paid { border-color: var(--accent-green); }
        .schedule-card.is-plan { border-color: #444444; opacity: 0.9; }
        .sc-index { width: 32px; height: 32px; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem; flex-shrink: 0; margin-right: 12px; }
        .schedule-card.is-paid .sc-index { background: var(--accent-blue); }
        .schedule-card.is-plan .sc-index { background: #444444; color: #aaaaaa; }
        .sc-date-status { display: flex; flex-direction: column; margin-right: auto; }
        .sc-date { font-weight: 600; font-size: 0.85rem; color: var(--text-primary); margin-bottom: 2px; }
        .sc-status { display: flex; align-items: center; font-size: 0.7rem; font-weight: 600;}
        .sc-status span { margin-right: 4px; font-size: 0.8rem;}
        .sc-status.paid { color: var(--accent-green); } .sc-status.plan { color: var(--text-secondary); }
        .sc-breakdown { display: flex; flex-direction: column; font-size: 0.7rem; text-align: right; margin-right: 14px; color: var(--text-secondary); }
        .sc-breakdown div { margin-bottom: 1px; }
        .sc-breakdown div span { color: var(--text-primary); font-weight: 500; font-size: 0.75rem; margin-left: 6px;}
        .sc-debt { text-align: right; min-width: 60px;}
        .sc-debt-label { font-size: 0.65rem; color: var(--text-secondary); margin-bottom: 1px;}
        .sc-debt-amount { font-weight: 700; font-size: 0.9rem; color: var(--text-primary); }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1100; display: none; align-items: center; justify-content: center; padding: 16px;}
        .modal-overlay.active { display: flex; }
        .modal-container { background: var(--bg-card); width: 100%; max-width: 450px; border-radius: 20px; padding: 24px; border: 1px solid var(--border-color); max-height: 90vh; overflow-y: auto;}

        /* Helpers */
        .text-primary { color: var(--accent-blue); } .text-danger { color: var(--accent-red); } .text-success { color: var(--accent-green); } .text-purple { color: var(--accent-purple); }

        /* Analysis & Guide Styles */
        .strategy-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 20px; margin-bottom: 16px; }
        .strategy-header { display: flex; align-items: center; margin-bottom: 16px; }
        .strategy-icon { font-size: 1.8rem; margin-right: 12px; }
        .strategy-title { font-size: 1.1rem; font-weight: 800; color: var(--text-primary); }
        .strategy-subtitle { font-size: 0.85rem; color: var(--text-secondary); margin-top: 2px;}
        
        /* Health Index Styles */
        .health-index-container { background: var(--bg-subtle); border-radius: 16px; padding: 20px; text-align: center; border: 1px solid var(--border-color); margin-bottom: 20px; }
        .health-gauge { position: relative; width: 120px; height: 60px; margin: 0 auto 10px auto; overflow: hidden; }
        .health-gauge-arc { width: 120px; height: 120px; border-radius: 50%; border: 12px solid var(--bg-card); border-bottom-color: transparent; border-left-color: transparent; transform: rotate(-45deg); position: absolute; top:0; left:0; }
        .health-gauge-fill { width: 120px; height: 120px; border-radius: 50%; border: 12px solid transparent; border-top-color: var(--accent-blue); transform: rotate(-45deg); position: absolute; top:0; left:0; transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .health-score-big { font-size: 2rem; font-weight: 900; line-height: 1; margin-top: -10px; }
        .health-status-label { font-weight: 700; text-transform: uppercase; font-size: 0.9rem; letter-spacing: 1px; margin-bottom: 6px; display: inline-block; padding: 4px 12px; border-radius: 20px; }

        /* Loan Summary Table */
        .loan-summary-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .loan-summary-table th { text-align: left; color: var(--text-secondary); font-weight: 600; padding: 8px 4px; border-bottom: 1px solid var(--border-color); }
        .loan-summary-table td { padding: 10px 4px; border-bottom: 1px solid var(--bg-subtle); vertical-align: middle; }
        .loan-summary-table tr:last-child td { border-bottom: none; }
        .rate-badge { background: var(--bg-subtle); padding: 2px 6px; border-radius: 6px; font-weight: 700; font-size: 0.75rem; border: 1px solid var(--border-color); }
        .rate-badge.high { border-color: var(--accent-red); color: var(--accent-red); background: rgba(239, 68, 68, 0.1); }

        /* Simulator Styles */
        .sim-input-group {
            display: flex; align-items: center; background: var(--bg-subtle); border: 1px solid var(--border-color); border-radius: 12px; padding: 12px 16px; width: 100%;
        }
        .sim-input-label {
            flex-shrink: 0; padding-right: 16px; color: var(--text-secondary); font-weight: 600; font-size: 0.9rem; white-space: nowrap;
        }
        .sim-input {
            flex: 1; width: 100%; background: transparent; border: none; padding: 0; color: var(--text-primary); font-weight: 800; font-size: 1.4rem; text-align: right; outline: none; font-family: 'Inter'; -moz-appearance: textfield;
        }
        .sim-input::-webkit-outer-spin-button, .sim-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .sim-btn { width: 100%; margin-top: 12px; background: var(--accent-purple); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.2s; }
        .sim-btn:hover { background: #9333ea; }
        .sim-btn:active { transform: scale(0.98); }

        /* Quick Calc Styles */
        .quick-calc-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 12px; }
        .qc-btn { background: var(--bg-subtle); border: 1px solid var(--border-color); color: var(--text-primary); padding: 10px; border-radius: 10px; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
        .qc-btn:hover { border-color: var(--accent-blue); background: var(--bg-card); }
        .qc-result { margin-top: 16px; text-align: center; padding: 16px; background: var(--bg-subtle); border-radius: 12px; border: 1px solid var(--accent-blue); }

        /* Action Timeline Styles */
        .timeline-container { margin-top: 20px; }
        .timeline-item { display: flex; gap: 16px; padding-bottom: 20px; position: relative; }
        .timeline-item::before { content: ''; position: absolute; left: 14px; top: 30px; bottom: 0; width: 2px; background: var(--border-color); z-index: 1; }
        .timeline-item:last-child::before { display: none; }
        .timeline-marker { width: 30px; height: 30px; border-radius: 50%; background: var(--bg-card); border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; color: var(--text-secondary); z-index: 2; flex-shrink: 0; }
        .timeline-item.current .timeline-marker { background: var(--accent-purple); border-color: var(--accent-purple); color: white; box-shadow: 0 0 10px rgba(168, 85, 247, 0.4); }
        .timeline-content { flex: 1; background: var(--bg-subtle); border-radius: 12px; padding: 16px; border: 1px solid var(--border-color); }
        .timeline-item.current .timeline-content { border-color: var(--accent-purple); }
        .timeline-date { font-weight: 700; font-size: 0.95rem; margin-bottom: 8px; color: var(--text-primary); }
        .timeline-action { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.4; margin-bottom: 8px;}
        .milestone-badge { display: inline-flex; align-items: center; background: rgba(34, 197, 94, 0.15); color: var(--accent-green); padding: 6px 12px; border-radius: 8px; font-weight: 700; font-size: 0.85rem; border: 1px solid rgba(34, 197, 94, 0.3); margin-top: 8px; width: 100%; }

        /* Comparison Tool Styles */
        .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
        .comp-item { background: var(--bg-subtle); padding: 16px; border-radius: 12px; border: 1px solid var(--border-color); text-align: center; }
        .comp-item.winner { border-color: var(--accent-green); background: rgba(34, 197, 94, 0.05); }
        .comp-label { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 6px; }
        .comp-val { font-weight: 800; font-size: 1.1rem; color: var(--text-primary); }
        .comp-val.bad { color: var(--accent-red); } .comp-val.good { color: var(--accent-green); }

        /* Charts & Period Selectors */
        .chart-container { position: relative; height: 320px; width: 100%; margin: 10px 0; } /* Increased height for bottom legend */
        .chart-container.small { height: 250px; } /* Increased height for bottom legend on dashboard */
        .period-selector { display: flex; gap: 4px; margin-bottom: 12px; justify-content: center; flex-wrap: wrap; }
        .period-btn { background: var(--bg-subtle); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .period-btn.active { background: var(--accent-blue); color: #fff; border-color: var(--accent-blue); }
        .linked-badge { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); padding: 3px 8px; border-radius: 6px; font-size: 0.6rem; font-weight: 700; text-transform: uppercase; margin-left: 6px; display: inline-flex; align-items: center; border: 1px solid var(--accent-blue); }
        .cat-tag { font-size: 0.6rem; color: var(--accent-blue); background: rgba(59, 130, 246, 0.15); padding: 2px 6px; border-radius: 5px; text-transform: uppercase; font-weight: 600; display: inline-block; border: 1px solid rgba(59, 130, 246, 0.2); vertical-align: middle; }

        /* Budget Progress Bars */
        .budget-item { margin-bottom: 16px; }
        .budget-header { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 6px; font-weight: 600; }
        .budget-progress-container { height: 8px; background: var(--bg-subtle); border-radius: 4px; overflow: hidden; }
        .budget-bar { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
        .budget-bar.green { background: var(--accent-green); }
        .budget-bar.yellow { background: var(--warn); }
        .budget-bar.red { background: var(--accent-red); }
        .budget-details { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px; }

        /* Filter controls */
        .filter-controls { background: var(--bg-subtle); padding: 12px; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 16px; }
        .filter-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .filter-input { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-primary); font-family: 'Inter'; font-size: 0.85rem; }

        /* --- SBALITELN√â KARTY (AKORDEON) --- */
        .settings-card-header {
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; padding-bottom: 10px;
        }
        .settings-card-header h2 { margin: 0; }
        .collapse-icon { transition: transform 0.3s ease; font-size: 0.8rem; color: var(--text-secondary); }
        .settings-card.active .collapse-icon { transform: rotate(180deg); }
        .settings-card-content {
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;
        }
        .card.settings-card { padding-bottom: 10px; }
        .settings-card.active .settings-card-content {
                padding-top: 16px; padding-bottom: 10px;
                max-height: 2000px;
        }


        /* === DRAG & DROP KATEGORIE === */
        .cat-sort-item { transition: background 0.15s; }
        .cat-sort-item.dragging { opacity: 0.4; background: var(--bg-subtle) !important; }
        .cat-sort-item.drag-over { background: rgba(59,130,246,0.12) !important; border-radius: 8px; }
        .cat-drag-handle:active { cursor: grabbing; }
    </style>
</head>
<body>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Header -->
    <header class="app-header">
        <div style="display:flex; align-items:center;">
            <div class="menu-toggle-btn" onclick="toggleMenu()">‚ò∞</div>
            <div class="app-title" style="margin-left: 16px;">Mince z <span>kapsy</span></div>
        </div>
        <button class="header-add-btn" onclick="openTxModal()">+</button>
    </header>

    <!-- Dark Sidebar Drawer -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMenu()"></div>
    <div class="sidebar-menu" id="sidebarMenu">
        <div class="sidebar-header">Mince z <span>kapsy</span></div>
        <nav class="sidebar-nav">
            <a href="#" class="nav-link active" onclick="switchView('dashboard', this)"> <span class="nav-link-icon">üìä</span> P≈ôehled </a>
            <a href="#" class="nav-link" id="nav-link-analysis" onclick="switchView('analysis-view', this)"> <span class="nav-link-icon" style="color: var(--accent-purple);">üß†</span> Anal√Ωza & Strategie </a>
            <a href="#" class="nav-link" onclick="switchView('transactions', this)"> <span class="nav-link-icon">üìÉ</span> Transakce </a>
            <a href="#" class="nav-link" onclick="switchView('loans', this)"> <span class="nav-link-icon">üè¶</span> P≈Øjƒçky </a>
            <a href="#" class="nav-link" onclick="switchView('charts', this)"> <span class="nav-link-icon">üìà</span> Grafy </a>
            <a href="#" class="nav-link" onclick="switchView('settings', this)"> <span class="nav-link-icon">‚öôÔ∏è</span> Nastaven√≠ </a>
        </nav>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- DASHBOARD -->
            <section id="dashboard" class="view-section active">
                <div class="card" style="display:flex; justify-content:space-between; align-items:center; background:var(--bg-subtle); padding:10px; border-radius:12px; margin-bottom:16px; border:1px solid var(--accent-blue);">
                    <button onclick="changeMonth(-1)" class="btn-icon" style="font-size:1.1rem;">‚Äπ</button>
                    <div id="current-view-label" style="font-weight:700; text-transform:uppercase; font-size: 0.9rem;">Prosinec 2025</div>
                    <button onclick="changeMonth(1)" class="btn-icon" style="font-size:1.1rem;">‚Ä∫</button>
                </div>
                <div class="card">
                    <button class="btn btn-primary btn-block" onclick="applyMonthly()" style="margin-bottom: 16px;">‚ö° Vlo≈æit trval√© platby manu√°lnƒõ</button>
                    <div style="display: flex; justify-content: space-between; text-align: center;">
                        <div><div style="font-size:0.65rem; color:var(--text-secondary)">P≈ò√çJMY MƒöS√çCE</div><div id="m-inc" class="text-success" style="font-weight:700; font-size:1rem;">0</div></div>
                        <div><div style="font-size:0.65rem; color:var(--text-secondary)">V√ùDAJE MƒöS√çCE</div><div id="m-exp" class="text-danger" style="font-weight:700; font-size:1rem;">0</div></div>
                        <div><div style="font-size:0.65rem; color:var(--text-secondary)">BILANCE MƒöS√çCE</div><div id="m-bal" style="font-weight:700; font-size:1rem;">0</div></div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>V√Ωdaje & Rozpoƒçet mƒõs√≠ce</h2>
                    <p style="text-align: center; font-size: 0.8rem; color: var(--text-secondary); margin: -10px 0 16px 0;">(Vƒçetnƒõ trval√Ωch plateb)</p>
                    <div class="chart-container small">
                        <canvas id="dashboardMonthPieChart"></canvas>
                    </div>
                     
                    <h3 style="margin-bottom: 16px; font-size: 0.95rem; margin-top: 24px;">Stav limit≈Ø kategori√≠</h3>
                    <div id="dashboardBudgetOverview"></div>
                </div>

                <div class="card">
                    <h2>Posledn√≠ aktivita (Tento mƒõs√≠c)</h2>
                    <div id="dashboardTxList"></div>
                </div>
            </section>

            <!-- FINANCIAL ANALYSIS SECTION -->
            <section id="analysis-view" class="view-section">
                <h2 style="letter-spacing: -0.5px; margin-bottom: 20px; font-size: 1.3rem;">Finanƒçn√≠ poradna & N√°stroje</h2>
                <div id="strategy-content"></div>
            </section>

            <!-- TRANSACTIONS SECTION WITH FILTERS -->
            <section id="transactions" class="view-section">
               <div class="card">
                   <h2>V≈°echny transakce</h2>
                   <div class="filter-controls">
                       <div class="filter-row">
                           <input type="date" id="filterDateFrom" class="filter-input" placeholder="Od">
                           <input type="date" id="filterDateTo" class="filter-input" placeholder="Do">
                       </div>
                       <div class="filter-row">
                           <select id="filterType" class="filter-input">
                               <option value="all">V≈°echny typy</option>
                               <option value="expense">Jen v√Ωdaje</option>
                               <option value="income">Jen p≈ô√≠jmy</option>
                           </select>
                           <button class="btn btn-primary btn-sm" onclick="applyFilters()">Filtrovat</button>
                       </div>
                       <div style="text-align: center; margin-top: 8px;">
                           <button class="btn btn-secondary btn-sm" onclick="resetFilters()" style="padding: 4px 12px; font-size: 0.75rem;">Reset filtr≈Ø</button>
                       </div>
                   </div>

                   <div id="fullTxList"></div>
               </div>
            </section>

            <!-- LOANS SECTION -->
            <section id="loans" class="view-section">
                <div id="loansOverviewSection">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin:0">P≈Øjƒçky a √∫vƒõry</h2>
                        <button class="btn btn-primary btn-sm" onclick="showLoanCreationForm()">Nov√Ω √∫vƒõr</button>
                    </div>

                    <div class="card" id="loansTotalSummary" style="background: var(--bg-subtle); border: 1px solid var(--accent-red); margin-bottom: 20px;">
                        <h3 style="color: var(--accent-red); margin-bottom: 10px;">Celkov√Ω p≈ôehled z√°vazk≈Ø</h3>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">Zb√Ωv√° doplatit celkem:</span>
                            <span id="totalLoansRemaining" style="font-weight: 800; font-size: 1.1rem; color: var(--text-primary);">0 Kƒç</span>
                        </div>
                         <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-secondary); font-size: 0.8rem;">Nejdel≈°√≠ doba spl√°cen√≠ (odhad):</span>
                            <span id="maxLoanTimeRemaining" style="font-weight: 600; font-size: 0.9rem; color: var(--text-primary);">-</span>
                        </div>
                    </div>

                    <div class="card" style="background: var(--bg-subtle); border: 1px solid var(--accent-green); margin-bottom: 20px; text-align: center;">
                        <h3 style="color: var(--text-primary); margin-bottom: 16px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">Souhrn spl√°tek (Tento mƒõs√≠c)</h3>
                        <div style="display: flex; justify-content: space-around; align-items: flex-end;">
                            <div>
                                <div id="loanSumTotal" style="font-size: 1.3rem; font-weight: 800; color: var(--accent-blue); line-height: 1;">0</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 6px; text-transform: uppercase;">Celkem</div>
                            </div>
                            <div>
                                <div id="loanSumPrincipal" style="font-size: 1.1rem; font-weight: 700; color: var(--accent-green); line-height: 1;">0</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 6px; text-transform: uppercase;">Jistina</div>
                            </div>
                            <div>
                                <div id="loanSumInterest" style="font-size: 1.1rem; font-weight: 700; color: var(--accent-red); line-height: 1;">0</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 6px; text-transform: uppercase;">√örok</div>
                            </div>
                        </div>
                    </div>

                    <div id="loansList"></div>
                </div>

                 <div class="card" id="loanCreationCard" style="display: none;">
                    <h2>Nov√Ω √∫vƒõr</h2>
                    <div class="form-grid two-col">
                        <div class="form-group" style="grid-column: 1/-1;"> <label class="form-label">N√°zev</label> <input type="text" id="newLoanName" class="form-input" placeholder="Nap≈ô. Hypot√©ka"> </div>
                        <div class="form-group"> <label class="form-label">P≈Øvodn√≠ v√Ω≈°e</label> <input type="number" id="newLoanOriginal" class="form-input" inputmode="decimal"> </div>
                        <div class="form-group"> <label class="form-label">Aktu√°ln√≠ z≈Østatek</label> <input type="number" id="newLoanCurrent" class="form-input" inputmode="decimal"> </div>
                        <div class="form-group"> <label class="form-label">√örok p.a. (%)</label> <input type="number" id="newLoanRate" class="form-input" step="0.01" inputmode="decimal"> </div>
                        <div class="form-group"> <label class="form-label">Mƒõs√≠ƒçn√≠ spl√°tka</label> <input type="number" id="newLoanPayment" class="form-input" inputmode="decimal"> </div>
                        <div class="form-group"> <label class="form-label">Datum naƒçerp√°n√≠</label> <input type="date" id="newLoanDisbursementDate" class="form-input"> </div>
                        <div class="form-group"> <label class="form-label">Datum 1. spl√°tky</label> <input type="date" id="newLoanFirstPaymentDate" class="form-input"> </div>
                        
                         <div style="grid-column: 1 / -1; margin-top: 12px; padding: 12px; background: var(--bg-subtle); border-radius: 12px; border: 1px solid var(--border-color);">
                             <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                 <input type="checkbox" id="useManualFirstPayment" onchange="toggleManualPaymentFields()" style="width: 18px; height: 18px; accent-color: var(--accent-blue);">
                                 <span style="font-weight: 600; font-size: 0.85rem; color: var(--text-primary);">Zadat prvn√≠ spl√°tku ruƒçnƒõ (podle v√Ωpisu)</span>
                             </label>
                             <div id="manualPaymentFields" class="form-grid two-col" style="display: none; margin-top: 16px;">
                                 <div class="form-group"> <label class="form-label text-primary">1. spl√°tka CELKEM</label> <input type="number" id="manualFirstTotal" class="form-input" style="border-color: var(--accent-blue);"> </div>
                                 <div class="form-group"> <label class="form-label text-danger">Z toho √öROK</label> <input type="number" id="manualFirstInterest" class="form-input" style="border-color: var(--accent-red);"> </div>
                             </div>
                         </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button class="btn btn-primary" style="flex: 2;" onclick="createNewLoan()">Ulo≈æit √∫vƒõr</button>
                        <button class="btn btn-secondary" style="flex: 1;" onclick="hideLoanCreationForm()">Zru≈°it</button>
                    </div>
                 </div>

                 <div id="loanDetailCard" class="card" style="display: none; padding: 0; overflow: hidden; background: var(--bg-app); border: none; box-shadow: none;">
                    <div style="padding: 20px; background: var(--bg-subtle); border-bottom: 1px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 16px; align-items: flex-start;">
                            <h2 id="detailLoanName" style="margin:0; font-size: 1.3rem; flex: 1;"></h2>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-icon" onclick="openLoanEditModal()" style="background: var(--bg-card); color: var(--accent-blue);">‚úé</button>
                                <button class="btn-icon" onclick="deleteLoanById(editingLoanId)" style="background: rgba(239,68,68,0.15); color: var(--accent-red); border: 1px solid var(--accent-red);">üóëÔ∏è</button>
                                <button class="btn-icon" onclick="closeLoanDetail()" style="background: var(--bg-card);">‚úï</button>
                            </div>
                        </div>
                        <div style="background: var(--bg-card); border: 1px solid var(--accent-blue); padding: 16px; border-radius: 16px; text-align: center; max-width: 360px; margin: 0 auto;">
                             <div style="color: var(--accent-blue); font-weight: 600; font-size: 0.8rem; margin-bottom: 4px;">AKTU√ÅLN√ç Z≈ÆSTATEK</div>
                             <div style="font-weight: 800; font-size: 1.6rem; color: var(--text-primary);" id="detailRemainingTop"></div>
                             <div class="item-sub" id="detailTerms" style="margin-top: 6px; font-size: 0.75rem;"></div>
                        </div>
                    </div>
                    
                    <div style="padding: 20px 12px;">
                        <div style="max-width: 360px; margin: 0 auto 24px auto;">
                             <div style="display: flex; justify-content: space-between; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; font-size: 0.85rem;">
                                <div>Splaceno: <span id="detailPaidTotal" class="text-success"></span></div>
                                <div id="detailProgressText">0%</div>
                            </div>
                            <div class="loan-progress-bg" style="margin-top: 0;"> <div id="detailProgressBar" class="loan-progress-fill" style="width: 0%"></div> </div>
                        </div>
                        <div id="loanScheduleList" class="schedule-list-container"></div>
                    </div>
                </div>
            </section>

            <!-- CHARTS Section -->
            <section id="charts" class="view-section">
                <div class="card">
                    <h2 style="margin-bottom: 16px;">P≈ô√≠jmy a v√Ωdaje v ƒçase</h2>
                    <div class="chart-controls">
                        <select id="incomeExpenseYearSelect" class="chart-select" onchange="updateIncomeExpenseChart()">
                        </select>
                    </div>
                    <div class="chart-container"><canvas id="incomeExpenseLineChart"></canvas></div>
                </div>
                
                <div class="card">
                    <h2 style="margin-bottom: 16px;">V√Ωvoj v√Ωdaj≈Ø/p≈ô√≠jm≈Ø dle kategorie</h2>
                    <div class="chart-controls">
                        <select id="trendType" class="chart-select" onchange="updateTrendCategorySelect(); updateTrendChart();">
                            <option value="expense">V√Ωdaje</option>
                            <option value="income">P≈ô√≠jmy</option>
                        </select>
                        <select id="trendYear" class="chart-select" onchange="updateTrendChart()">
                        </select>
                        <select id="trendCategory" class="chart-select" onchange="updateTrendChart()">
                        </select>
                    </div>
                    <div class="chart-container"><canvas id="trendChart"></canvas></div>
                </div>
                
                <div class="card">
                    <h2 style="margin-bottom: 16px;">Struktura v√Ωdaj≈Ø (Dlouhodob√°)</h2>
                    <div class="chart-controls">
                        <select id="pieChartModeSelect" class="chart-select" onchange="switchPieModeFromSelect(this.value)">
                        </select>
                    </div>
                    <div class="chart-container"><canvas id="pieChart"></canvas></div>
                </div>
                <div class="card">
                    <h2 style="margin-bottom: 16px;">Mƒõs√≠ƒçn√≠ bilance (Zisk/Ztr√°ta)</h2>
                    <div class="chart-controls">
                        <select id="balancePeriodSelect" class="chart-select" onchange="updateBalanceChartFromSelect()">
                            <option value="3">3 mƒõs√≠ce</option>
                            <option value="6">6 mƒõs√≠c≈Ø</option>
                            <option value="12" selected>12 mƒõs√≠c≈Ø</option>
                        </select>
                        <select id="balanceYearSelect" class="chart-select" onchange="updateBalanceChartFromSelect()">
                        </select>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 10px; font-size: 0.8rem;">
                        <div style="display: flex; align-items: center;"><div style="width: 12px; height: 12px; background: #22c55e; margin-right: 6px; border-radius: 3px;"></div> Zisk (P≈ôebytek)</div>
                        <div style="display: flex; align-items: center;"><div style="width: 12px; height: 12px; background: #ef4444; margin-right: 6px; border-radius: 3px;"></div> Ztr√°ta (Deficit)</div>
                    </div>
                    <div class="chart-container"><canvas id="balanceChart"></canvas></div>
                </div>
            </section>

            <!-- SETTINGS SECTION -->
            <section id="settings" class="view-section">
                
                <!-- UPRAVENO: Roz≈°√≠≈ôen√° karta s p≈ôep√≠naƒçi pro v√≠ce n√°stroj≈Ø -->
                <div class="card settings-card">
                    <div class="settings-card-header" onclick="toggleSettingsCard(this)">
                        <h2>Zobrazen√≠ n√°stroj≈Ø anal√Ωzy</h2><span class="collapse-icon">‚ñº</span>
                    </div>
                    <div class="settings-card-content">
                        <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px;">Vyberte, kter√© n√°stroje se maj√≠ zobrazovat v sekci Anal√Ωza & Strategie.</p>
                        
                        <!-- P≈Øvodn√≠ n√°stroje -->
                        <div class="form-group" style="margin-bottom: 8px;"><label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600;"><input type="checkbox" class="analysis-toggle" data-tool="showHealth" style="width: 18px; height: 18px; accent-color: var(--accent-blue);"> Index finanƒçn√≠ho zdrav√≠ </label></div>
                        <div class="form-group" style="margin-bottom: 8px;"><label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600;"><input type="checkbox" class="analysis-toggle" data-tool="showDebt" style="width: 18px; height: 18px; accent-color: var(--accent-blue);"> Simul√°tor oddlu≈æen√≠ & Strategie </label></div>
                        <div class="form-group" style="margin-bottom: 8px;"><label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600;"><input type="checkbox" class="analysis-toggle" data-tool="showCalc" style="width: 18px; height: 18px; accent-color: var(--accent-blue);"> Rychl√° kalkulaƒçka rezervy </label></div>
                        <div class="form-group" style="margin-bottom: 8px;"><label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600;"><input type="checkbox" class="analysis-toggle" data-tool="showSavings" style="width: 18px; height: 18px; accent-color: var(--accent-blue);"> Kalkulaƒçka spo≈ô√≠c√≠ho c√≠le </label></div>

                        <!-- Nov√© n√°stroje -->
                        <div class="form-group" style="margin-bottom: 8px; border-top: 1px solid var(--border-color); padding-top: 8px;"><label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600;"><input type="checkbox" class="analysis-toggle" data-tool="showRule503020" style="width: 18px; height: 18px; accent-color: var(--accent-cyan);"> Pravidlo 50/30/20 (Snapshot) </label></div>
                        <div class="form-group" style="margin-bottom: 8px;"><label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600;"><input type="checkbox" class="analysis-toggle" data-tool="showNetWorth" style="width: 18px; height: 18px; accent-color: var(--accent-cyan);"> Odhad ƒçist√©ho jmƒõn√≠ </label></div>
                        <div class="form-group" style="margin-bottom: 8px;"><label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600;"><input type="checkbox" class="analysis-toggle" data-tool="showDailyCost" style="width: 18px; height: 18px; accent-color: var(--accent-cyan);"> Kalkulaƒçka denn√≠ch n√°vyk≈Ø </label></div>
                        <div class="form-group" style="margin-bottom: 8px;"><label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600;"><input type="checkbox" class="analysis-toggle" data-tool="showSavingsRate" style="width: 18px; height: 18px; accent-color: var(--accent-orange);"> Odhad m√≠ry √∫spor </label></div>
                        <div class="form-group" style="margin-bottom: 8px;"><label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600;"><input type="checkbox" class="analysis-toggle" data-tool="showHourlyValue" style="width: 18px; height: 18px; accent-color: var(--accent-orange);"> Hodinov√° hodnota ƒçasu </label></div>
                        <div class="form-group" style="margin-bottom: 8px;"><label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600;"><input type="checkbox" class="analysis-toggle" data-tool="showPayYourselfFirst" style="width: 18px; height: 18px; accent-color: var(--accent-orange);"> Kontrola "Zapla≈• si prvn√≠" </label></div>
                        <div class="form-group" style="margin-bottom: 16px;"><label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600;"><input type="checkbox" class="analysis-toggle" data-tool="showSubAudit" style="width: 18px; height: 18px; accent-color: var(--accent-orange);"> Audit p≈ôedplatn√Ωch (≈†ablony) </label></div>

                        <!-- Nov√© pokroƒçil√© n√°stroje -->
                        <div class="form-group" style="margin-bottom: 8px; border-top: 1px solid var(--border-color); padding-top: 8px;"><label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600;"><input type="checkbox" class="analysis-toggle" data-tool="showExpenseTrends" style="width: 18px; height: 18px; accent-color: var(--accent-purple);"> üìä Anal√Ωza v√Ωdajov√Ωch trend≈Ø </label></div>
                        <div class="form-group" style="margin-bottom: 8px;"><label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600;"><input type="checkbox" class="analysis-toggle" data-tool="showFIRE" style="width: 18px; height: 18px; accent-color: var(--accent-purple);"> üî• FIRE kalkulaƒçka </label></div>
                        <div class="form-group" style="margin-bottom: 8px;"><label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600;"><input type="checkbox" class="analysis-toggle" data-tool="showInflation" style="width: 18px; height: 18px; accent-color: var(--accent-purple);"> üìà Inflaƒçn√≠ dopad </label></div>
                        <div class="form-group" style="margin-bottom: 8px;"><label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600;"><input type="checkbox" class="analysis-toggle" data-tool="showLeakDetector" style="width: 18px; height: 18px; accent-color: var(--accent-purple);"> üîç Kategorie "leak" detektor </label></div>
                        <div class="form-group" style="margin-bottom: 8px;"><label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600;"><input type="checkbox" class="analysis-toggle" data-tool="showFixedVsVariable" style="width: 18px; height: 18px; accent-color: var(--accent-purple);"> ‚öñÔ∏è Pomƒõr fixn√≠ch vs variabiln√≠ch </label></div>
                        <div class="form-group" style="margin-bottom: 8px;"><label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600;"><input type="checkbox" class="analysis-toggle" data-tool="showScenario" style="width: 18px; height: 18px; accent-color: var(--accent-purple);"> üé≤ Sc√©n√°≈ôov√° anal√Ωza </label></div>
                        <div class="form-group" style="margin-bottom: 16px;"><label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600;"><input type="checkbox" class="analysis-toggle" data-tool="showForecast" style="width: 18px; height: 18px; accent-color: var(--accent-purple);"> üìÖ Roƒçn√≠ forecast </label></div>

                        <button class="btn btn-primary btn-block" onclick="saveAnalysisSettings()">Ulo≈æit zobrazen√≠ n√°stroj≈Ø</button>
                    </div>
                </div>

                <div class="card settings-card">
                    <div class="settings-card-header" onclick="toggleSettingsCard(this)">
                        <h2>Bankovn√≠ √∫ƒçet</h2><span class="collapse-icon">‚ñº</span>
                    </div>
                    <div class="settings-card-content">
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label class="form-label">Aktu√°ln√≠ z≈Østatek</label>
                            <div style="display: flex; gap: 12px;">
                                <input type="number" id="setBalanceInput" class="form-input" inputmode="decimal">
                                <button class="btn btn-primary" style="padding: 0 20px;" onclick="setManualBalance()">Ulo≈æit</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card settings-card">
                    <div class="settings-card-header" onclick="toggleSettingsCard(this)">
                        <h2>Transakce</h2><span class="collapse-icon">‚ñº</span>
                    </div>
                    <div class="settings-card-content">
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label class="form-label">Poƒçet zobrazen√Ωch transakc√≠ v mƒõs√≠ƒçn√≠m p≈ôehledu</label>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <input type="number" id="transactionLimitInput" class="form-input" min="1" max="50" value="5" style="flex: 1;">
                                <button class="btn btn-primary" style="padding: 0 20px;" onclick="saveTransactionLimit()">Ulo≈æit</button>
                            </div>
                            <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 8px;">Nastavte, kolik posledn√≠ch transakc√≠ se m√° zobrazovat v p≈ôehledu dole u ka≈æd√©ho mƒõs√≠ce (v√Ωchoz√≠: 5)</p>
                        </div>
                    </div>
                </div>

                 <div class="card settings-card">
                    <div class="settings-card-header" onclick="toggleSettingsCard(this)">
                        <h2>Trval√© platby (≈†ablony)</h2><span class="collapse-icon">‚ñº</span>
                    </div>
                    <div class="settings-card-content">
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Typ</label><select id="templType" class="form-select" onchange="updateCategoryDropdown('templ')"><option value="expense">V√Ωdaj (-)</option><option value="income">P≈ô√≠jem (+)</option></select></div>
                            <div class="form-group"><label class="form-label">N√°zev</label><input type="text" id="templDesc" class="form-input" placeholder="Nap≈ô. N√°jem"></div>
                            <div class="form-grid two-col"><div class="form-group"><label class="form-label">ƒå√°stka</label>
                      <input type="number" id="templAmount" class="form-input" inputmode="decimal"></div><div class="form-group"><label class="form-label">Den v mƒõs√≠ci</label><input type="number" id="templDay" class="form-input" min="1" max="31" placeholder="Nap≈ô. 15"></div></div>
                            <div class="form-group"><label class="form-label">Kategorie</label><select id="templCategory" class="form-select"></select></div>
                            <button id="addTemplateBtn" class="btn btn-primary" onclick="addTemplate()">P≈ôidat ≈°ablonu</button>
                        </div>
                        <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 12px;">≈†ablony se automaticky za√∫ƒçtuj√≠ v dan√Ω den mƒõs√≠ce, pokud aplikaci ten den otev≈ôete.</p>
                        <div id="templateList" style="margin-top: 20px;"></div>
                    </div>
                </div>
                
                <div class="card settings-card">
                    <div class="settings-card-header" onclick="toggleSettingsCard(this)">
                        <h2>Limity rozpoƒçtu (Mƒõs√≠ƒçn√≠)</h2><span class="collapse-icon">‚ñº</span>
                    </div>
                    <div class="settings-card-content">
                        <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 16px;">Nastavte si maxim√°ln√≠ mƒõs√≠ƒçn√≠ √∫tratu pro jednotliv√© kategorie. Pomoc√≠ za≈°krt√°vac√≠ho pol√≠ƒçka m≈Ø≈æete kategorie skr√Ωt z p≈ôehledu na n√°stƒõnce (vhodn√© pro fixn√≠ n√°klady).</p>
                        <div id="categoryLimitsSettingsList" class="form-grid"></div>
                        <button class="btn btn-primary btn-block" style="margin-top: 16px;" onclick="saveAllCategoryLimits()">Ulo≈æit limity a nastaven√≠</button>
                    </div>
                </div>

                <!-- UPRAVENO: Nov√° sekce pro spr√°vu kategori√≠ a barev -->
                <div class="card settings-card">
                    <div class="settings-card-header" onclick="toggleSettingsCard(this)">
                        <h2>Spr√°va kategori√≠ a barev</h2><span class="collapse-icon">‚ñº</span>
                    </div>
                    <div class="settings-card-content">
                        <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 16px;">Zde m≈Ø≈æete p≈ôid√°vat, odeb√≠rat a mƒõnit barvy kategori√≠ pro zobrazen√≠ v grafech.</p>
                        <div class="form-group" style="margin-bottom: 16px;"><div style="display: flex; gap: 10px;"><input type="text" id="setNewCatName" class="form-input" placeholder="Nov√° kategorie" style="flex: 2;"><select id="setNewCatType" class="form-select" style="flex: 1;"> <option value="expense">V√Ωdaj</option> <option value="income">P≈ô√≠jem</option> </select><button class="btn btn-primary" style="padding: 0 16px;" onclick="settingsAddCategory()">P≈ôidat</button></div></div>
                        <div class="cat-list-container" style="display: flex; flex-direction: column; gap: 20px;">
                            <div> <h4>V√Ωdaje</h4> <div id="setCatListExpense"></div> </div>
                            <div> <h4>P≈ô√≠jmy</h4> <div id="setCatListIncome"></div> </div>
                        </div>
                    </div>
                </div>

                <div class="card settings-card">
                    <div class="settings-card-header" onclick="toggleSettingsCard(this)">
                        <h2>Z√°lohov√°n√≠ dat</h2><span class="collapse-icon">‚ñº</span>
                    </div>
                    <div class="settings-card-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;"><button class="btn btn-secondary" onclick="exportData()">üì• St√°hnout</button><label class="btn btn-secondary" style="display:flex;align-items:center;justify-content:center;cursor:pointer;margin:0;">üì§ Nahr√°t<input type="file" id="importInput" onchange="importData(event)" accept=".json" style="position:absolute;opacity:0;width:1px;height:1px;"></label></div>
                    </div>
                </div>
                 
                 <div class="card settings-card" style="border: 1px solid var(--accent-red);">
                    <div class="settings-card-header" onclick="toggleSettingsCard(this)">
                        <h2 class="text-danger">Reset aplikace</h2><span class="collapse-icon">‚ñº</span>
                    </div>
                    <div class="settings-card-content">
                        <button class="btn btn-danger btn-block" onclick="clearAllData()">Smazat v≈°echna data</button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- NOV√Å SPODN√ç LI≈†TA SE Z≈ÆSTATKEM -->
    <div class="bottom-app-bar">
        <span style="font-size: 0.85rem; color: var(--text-secondary);">Aktu√°ln√≠ z≈Østatek:</span>
        <span id="bottomBarBalance" style="font-size: 1.1rem; font-weight: 800; color: var(--accent-blue); margin-left: 10px;">0 Kƒç</span>
    </div>

    <!-- Transaction Modal -->
    <div class="modal-overlay" id="txModal">
        <div class="modal-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;"> <h2 id="txModalTitle" style="margin:0">Transakce</h2> <button class="btn-icon" onclick="closeTxModal()">‚úï</button> </div>
            <form id="transactionForm">
                <input type="hidden" id="editTxId"> 
                <div class="form-grid">
                    <div class="form-group"> <label class="form-label">Typ</label> <select id="transType" class="form-select" onchange="updateCategoryDropdown('trans')"> <option value="expense">V√Ωdaj (-)</option> <option value="income">P≈ô√≠jem (+)</option> </select> </div>
                    <div class="form-group"> <label class="form-label">Popis (Voliteln√©)</label> <input type="text" id="transDesc" class="form-input" placeholder="Nap≈ô. Obƒõd"> </div>
                    <div class="form-group"> <label class="form-label">ƒå√°stka</label> <input type="number" id="transAmount" class="form-input" required min="1" inputmode="decimal"> </div>
                    <div class="form-group"> <label class="form-label">Kategorie</label> <select id="transCategory" class="form-select" required onchange="checkTxLoanLinking()"> </select> </div>
                    <div id="transLoanLinkSection" class="form-group" style="display: none; background: var(--bg-subtle); padding: 12px; border-radius: 8px; border: 1px solid var(--accent-blue);">
                        <label class="form-label text-primary">P≈ôi≈ôadit k √∫vƒõru (Mimo≈ô√°dn√° spl√°tka)</label>
                        <select id="transLinkedLoan" class="form-select" style="border-color: var(--accent-blue);"> <option value="">-- Vyberte √∫vƒõr --</option> </select>
                    </div>
                    <div class="form-group"> <label class="form-label">Datum</label> <input type="date" id="transDate" class="form-input" required> </div>
                    <button type="button" class="btn btn-primary btn-block" style="margin-top: 12px; padding: 14px;" onclick="UI_saveTransactionClick()">Ulo≈æit transakci</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loan Edit Modal -->
    <div class="modal-overlay" id="loanEditModal">
        <div class="modal-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;"> <h2 style="margin:0">Upravit √∫vƒõr</h2> <button class="btn-icon" onclick="closeLoanEditModal()">‚úï</button> </div>
            <input type="hidden" id="editLoanId">
            <div class="form-grid">
                <div class="form-group"> <label class="form-label">N√°zev</label> <input type="text" id="editLoanName" class="form-input"> </div>
                <div class="form-group"> <label class="form-label">√örok p.a. (%)</label> <input type="number" id="editLoanRate" class="form-input" step="0.01" inputmode="decimal"> </div>
                <div class="form-group"> <label class="form-label">Mƒõs√≠ƒçn√≠ spl√°tka</label> <input type="number" id="editLoanPayment" class="form-input" inputmode="decimal"> </div>
                <p style="font-size: 0.8rem; color: var(--warn); background: rgba(241, 224, 90, 0.1); padding: 10px; border-radius: 8px;">‚ö†Ô∏è Zmƒõna √∫roku nebo spl√°tky ovlivn√≠ budouc√≠ kalend√°≈ô, ale nep≈ôepoƒç√≠t√° ji≈æ probƒõhl√© platby.</p>
                <button type="button" class="btn btn-primary btn-block" style="margin-top: 12px; padding: 14px;" onclick="saveLoanEdit()">Ulo≈æit zmƒõny</button>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_CATEGORIES = { income: ['Mzda', 'Prodej', 'Ostatn√≠'], expense: ['J√≠dlo', 'Bydlen√≠', 'Doprava', 'Z√°bava', 'P≈Øjƒçka', 'Ostatn√≠'] };
        const DEFAULT_HIDDEN_CATEGORIES = ['N√°jem', 'P≈Øjƒçka', 'Poji≈°tƒõn√≠', 'T-Mobile', 'TV+rozhlas', 'Elekt≈ôina', 'Plyn'];
        // UPRAVENO: V√Ωchoz√≠ barvy pro kategorie
        const DEFAULT_CATEGORY_COLORS = {
            'J√≠dlo': '#3b82f6', 'Bydlen√≠': '#22c55e', 'Doprava': '#ef4444', 'Z√°bava': '#f59e0b', 'P≈Øjƒçka': '#a855f7', 'Ostatn√≠': '#666666',
            'Mzda': '#22c55e', 'Prodej': '#3b82f6'
        };
        const DEFAULT_ANALYSIS_SETTINGS = { 
            showHealth: true, showDebt: true, showCalc: true, showSavings: true,
            showRule503020: true, showNetWorth: true, showDailyCost: true, 
            showSavingsRate: true, showHourlyValue: true, showPayYourselfFirst: true, showSubAudit: true,
            showExpenseTrends: true, showFIRE: true, showInflation: true, showLeakDetector: true, 
            showFixedVsVariable: true, showScenario: true, showForecast: true
        };

        let AppState = { 
            balance: 0, transactions: [], loans: [], templates: [], 
            categories: JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)), 
            categoryLimits: {}, 
            categoryColors: JSON.parse(JSON.stringify(DEFAULT_CATEGORY_COLORS)), // UPRAVENO: P≈ôid√°ny barvy do stavu
            hiddenBudgetCategories: [], 
            analysisSettings: JSON.parse(JSON.stringify(DEFAULT_ANALYSIS_SETTINGS)),
            transactionLimit: 5  // V√Ωchoz√≠ poƒçet zobrazen√Ωch transakc√≠
        };
        const STORAGE_KEY = 'SmartBudget_DarkMobile_v16_Colors'; // Bump version
        let expenseChartInstance = null; let balanceChartInstance = null; let payoffChartInstance = null; let simYearlyChartInstance = null;
        let dashboardMonthPieChartInstance = null;
        let incomeExpenseLineChartInstance = null;
        let editingTxId = null; let editingLoanId = null;
        let viewDate = new Date(); viewDate.setDate(1);
        let pieChartMode = 'overall';

        // --- TOAST NOTIFICATIONS ---

        // === DRAG & DROP ≈òAZEN√ç KATEGORI√ç ===
        function initCatDragDrop(list, type) {
            var dragSrc = null;

            function getItems() { return Array.from(list.querySelectorAll('.cat-sort-item')); }

            function onDragStart(e) {
                dragSrc = this;
                this.classList.add('dragging');
                if (e.dataTransfer) {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', this.dataset.idx);
                }
            }
            function onDragOver(e) {
                e.preventDefault();
                if (e.dataTransfer) e.dataTransfer.dropEffect = 'move';
                getItems().forEach(i => i.classList.remove('drag-over'));
                this.classList.add('drag-over');
            }
            function onDragLeave() { this.classList.remove('drag-over'); }
            function onDrop(e) {
                e.preventDefault();
                if (!dragSrc || dragSrc === this) return;
                var fromIdx = parseInt(dragSrc.dataset.idx);
                var toIdx = parseInt(this.dataset.idx);
                var cats = AppState.categories[type];
                var moved = cats.splice(fromIdx, 1)[0];
                cats.splice(toIdx, 0, moved);
                saveData();
                renderSettingsCategories();
                updateCategoryDropdown('trans');
                updateCategoryDropdown('templ');
                showToast('Po≈ôad√≠ ulo≈æeno');
            }
            function onDragEnd() {
                getItems().forEach(i => { i.classList.remove('dragging'); i.classList.remove('drag-over'); });
            }

            // Touch podpora pro mobil
            var touchSrc = null, touchClone = null, touchFromIdx = -1;
            function onTouchStart(e) {
                var handle = e.target.closest('.cat-drag-handle');
                if (!handle) return;
                e.preventDefault();
                touchSrc = this;
                touchFromIdx = parseInt(this.dataset.idx);
                this.classList.add('dragging');
                // Vytvo≈ô vizu√°ln√≠ klon
                touchClone = this.cloneNode(true);
                touchClone.style.cssText = 'position:fixed;z-index:9999;opacity:0.85;pointer-events:none;width:'+this.offsetWidth+'px;background:var(--bg-card);border-radius:10px;padding:10px;border:1px solid var(--accent-blue);';
                document.body.appendChild(touchClone);
            }
            function onTouchMove(e) {
                if (!touchSrc) return;
                e.preventDefault();
                var t = e.touches[0];
                if (touchClone) {
                    touchClone.style.left = (t.clientX - touchClone.offsetWidth/2) + 'px';
                    touchClone.style.top  = (t.clientY - 30) + 'px';
                }
                // Najdi element pod dotykem
                touchClone.style.display = 'none';
                var el = document.elementFromPoint(t.clientX, t.clientY);
                touchClone.style.display = '';
                var target = el ? el.closest('.cat-sort-item') : null;
                getItems().forEach(i => i.classList.remove('drag-over'));
                if (target && target !== touchSrc) target.classList.add('drag-over');
            }
            function onTouchEnd(e) {
                if (!touchSrc) return;
                if (touchClone) { document.body.removeChild(touchClone); touchClone = null; }
                var t = e.changedTouches[0];
                var el = document.elementFromPoint(t.clientX, t.clientY);
                var target = el ? el.closest('.cat-sort-item') : null;
                getItems().forEach(i => { i.classList.remove('dragging'); i.classList.remove('drag-over'); });
                if (target && target !== touchSrc) {
                    var toIdx = parseInt(target.dataset.idx);
                    var cats = AppState.categories[type];
                    var moved = cats.splice(touchFromIdx, 1)[0];
                    cats.splice(toIdx, 0, moved);
                    saveData();
                    renderSettingsCategories();
                    updateCategoryDropdown('trans');
                    updateCategoryDropdown('templ');
                    showToast('Po≈ôad√≠ ulo≈æeno');
                }
                touchSrc = null; touchFromIdx = -1;
            }

            getItems().forEach(function(item) {
                // Desktop drag
                item.setAttribute('draggable', 'true');
                item.addEventListener('dragstart', onDragStart);
                item.addEventListener('dragover', onDragOver);
                item.addEventListener('dragleave', onDragLeave);
                item.addEventListener('drop', onDrop);
                item.addEventListener('dragend', onDragEnd);
                // Touch
                item.addEventListener('touchstart', onTouchStart, {passive:false});
                item.addEventListener('touchmove', onTouchMove, {passive:false});
                item.addEventListener('touchend', onTouchEnd);
            });
        }

        function showToast(message) {
            const container = document.getElementById('toast-container'); if (!container) return;
            const toast = document.createElement('div'); toast.className = 'toast'; toast.innerHTML = `<span class="toast-icon">‚úÖ</span> ${message}`;
            container.appendChild(toast); void toast.offsetWidth; toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 350); }, 2000);
        }

        // --- INITIALIZATION ---
        function init() {
            loadData(); 
            const todayIso = new Date().toISOString().split('T')[0];
            document.getElementById('transDate').value = todayIso; document.getElementById('newLoanDisbursementDate').value = todayIso;
            let nextMonth = new Date(); nextMonth.setMonth(nextMonth.getMonth() + 1); nextMonth.setDate(15);
            document.getElementById('newLoanFirstPaymentDate').value = nextMonth.toISOString().split('T')[0];
            
            // Nastaven√≠ hodnoty transaction limit
            const transLimitInput = document.getElementById('transactionLimitInput');
            if (transLimitInput) transLimitInput.value = AppState.transactionLimit || 5;
            
            resetFilters();

            updateCategoryDropdown('trans'); updateCategoryDropdown('templ');
            
            checkDailyStandingOrders();

            updateUI();
            
            // Inicializace nov√Ωch prvk≈Ø
            if (document.getElementById('trendChart')) initTrendChart();
            
            setTimeout(() => { updatePieChart(); updateBalanceChart(12); }, 500);
        }
        
        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) { 
                try { 
                    AppState = JSON.parse(saved); 
                    if (!AppState.templates) AppState.templates = []; 
                    if (!AppState.categories || !Array.isArray(AppState.categories.income) || !Array.isArray(AppState.categories.expense)) { AppState.categories = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)); } 
                    if (!AppState.categoryLimits) AppState.categoryLimits = {};
                    if (!AppState.categoryColors) AppState.categoryColors = JSON.parse(JSON.stringify(DEFAULT_CATEGORY_COLORS)); // UPRAVENO: Naƒçten√≠ barev nebo v√Ωchoz√≠
                    if (!AppState.hiddenBudgetCategories) AppState.hiddenBudgetCategories = [...DEFAULT_HIDDEN_CATEGORIES];
                    AppState.analysisSettings = { ...DEFAULT_ANALYSIS_SETTINGS, ...(AppState.analysisSettings || {}) };
                    if (!AppState.transactionLimit || AppState.transactionLimit < 1) AppState.transactionLimit = 5;
                } catch (e) { resetAppState(); } 
            } else { resetAppState(); }
             if(AppState.categories && AppState.categories.expense && !AppState.categories.expense.includes('P≈Øjƒçka')) { AppState.categories.expense.push('P≈Øjƒçka'); }
             // Ensure all categories have a color
             ['income', 'expense'].forEach(type => {
                 AppState.categories[type].forEach(cat => {
                     if (!AppState.categoryColors[cat]) AppState.categoryColors[cat] = '#' + Math.floor(Math.random()*16777215).toString(16);
                 });
             });
        }
        function resetAppState() { AppState = { balance: 0, transactions: [], loans: [], categories: JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)), templates: [], categoryLimits: {}, categoryColors: JSON.parse(JSON.stringify(DEFAULT_CATEGORY_COLORS)), hiddenBudgetCategories: [...DEFAULT_HIDDEN_CATEGORIES], analysisSettings: JSON.parse(JSON.stringify(DEFAULT_ANALYSIS_SETTINGS)), transactionLimit: 5 }; saveData(); }
        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(AppState)); updateUI(); }
        function clearAllData() { if(confirm("Opravdu smazat ve≈°ker√° data?")) { try{localStorage.removeItem(STORAGE_KEY);}catch(e){} resetAppState(); updateUI(); showToast("Data smaz√°na"); }}

        // --- NAVIGATION & VIEWS ---
        function toggleMenu() { document.getElementById('sidebarMenu').classList.toggle('active'); document.getElementById('sidebarOverlay').classList.toggle('active'); }
        function switchView(viewId, navElement) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active')); document.getElementById(viewId).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active')); if(navElement) navElement.classList.add('active');
            if(viewId === 'dashboard') { updatePieChart(); renderDashboardBudgetOverview(); } 
            if(viewId === 'charts') { setTimeout(function(){ try{initTrendChart();}catch(e){} try{updatePieChart();}catch(e){} try{updateBalanceChart(12);}catch(e){} try{var s=document.getElementById('incomeExpenseYearSelect');renderIncomeExpenseLineChart(s?parseInt(s.value):new Date().getFullYear());}catch(e){}; }, 80); }
            if(viewId === 'loans') { closeLoanDetail(); hideLoanCreationForm(); }
            if(viewId === 'analysis-view') { renderAnalysisView(); }
            if(viewId === 'settings') { renderSettingsCategories(); updateAnalysisSettingsUI(); } 
            toggleMenu(); window.scrollTo(0,0);
        }
        function changeMonth(dir) { viewDate.setMonth(viewDate.getMonth() + dir); updateUI(); }
        function openTxModal(isEdit = false) { document.getElementById('txModal').classList.add('active'); updateCategoryDropdown('trans'); document.getElementById('txModalTitle').textContent = isEdit ? 'Upravit' : 'Nov√° transakce'; }
        function closeTxModal() { document.getElementById('txModal').classList.remove('active'); editingTxId = null; document.getElementById('transactionForm').reset(); document.getElementById('transDate').value = new Date().toISOString().split('T')[0]; checkTxLoanLinking(); }
        
        // --- UI UPDATES ---
        function updateUI() { 
            document.getElementById('bottomBarBalance').textContent = formatMoney(AppState.balance);
            document.getElementById('setBalanceInput').value = AppState.balance;
            const mNames = ["Leden", "√önor", "B≈ôezen", "Duben", "Kvƒõten", "ƒåerven", "ƒåervenec", "Srpen", "Z√°≈ô√≠", "≈ò√≠jen", "Listopad", "Prosinec"];
            document.getElementById('current-view-label').innerText = mNames[viewDate.getMonth()] + " " + viewDate.getFullYear();
            updateStats(); 
            renderTransactionLists(); 
            renderLoansOverview(); 
            renderTemplates(); 
            updateCategoryDropdown('templ');
            renderDashboardBudgetOverview();
        }
        function updateStats() {
            let inc = 0, exp = 0; AppState.transactions.forEach(t => { const d = new Date(t.date); if(d.getMonth() === viewDate.getMonth() && d.getFullYear() === viewDate.getFullYear()) { if(t.type === 'income') inc += t.amount; else exp += t.amount; } });
            document.getElementById('m-inc').innerText = formatMoney(inc); document.getElementById('m-exp').innerText = formatMoney(exp); document.getElementById('m-bal').innerText = formatMoney(inc - exp);
        }
        function updateCategoryDropdown(prefix) { const typeEl = document.getElementById(prefix + 'Type'); const type = typeEl ? typeEl.value : 'expense'; const select = document.getElementById(prefix + 'Category'); if (!select) return; select.innerHTML = ''; if (AppState.categories && Array.isArray(AppState.categories[type])) { AppState.categories[type].forEach(cat => { select.innerHTML += `<option value="${cat}">${cat}</option>`; }); } if(prefix === 'trans') checkTxLoanLinking(); }

        // --- TRANSACTIONS & LOAN LOGIC ---
        function createTransactionInternal(data) { if (data.type === 'income') AppState.balance += data.amount; else AppState.balance -= data.amount; if (data.linkedLoanId && data.type === 'expense') { const loan = AppState.loans.find(l => l.id === data.linkedLoanId); if (loan) loan.currentPrincipal = Math.max(0, loan.currentPrincipal - (data.principalAmount !== undefined ? data.principalAmount : data.amount)); } AppState.transactions.unshift({ id: "tx_" + Date.now(), ...data }); }
        function UI_saveTransactionClick() { const type = document.getElementById('transType').value; const amount = parseFloat(document.getElementById('transAmount').value); const desc = document.getElementById('transDesc').value; const category = document.getElementById('transCategory').value; const date = document.getElementById('transDate').value; const linkedLoanId = document.getElementById('transLinkedLoan').value || null; if (!amount || amount <= 0 || !date) { alert('Vypl≈àte ƒç√°stku a datum.'); return; } if(editingTxId) deleteTransactionInternal(editingTxId); 
        let calculatedPrincipal = 0;
        if (linkedLoanId && type === 'expense') {
            const loan = AppState.loans.find(l => l.id === linkedLoanId);
            if (loan) {
                const interest = loan.currentPrincipal * (loan.interestRate/100/12);
                calculatedPrincipal = Math.min(loan.currentPrincipal, amount - interest);
                if (calculatedPrincipal < 0) calculatedPrincipal = 0;
            }
        }
        createTransactionInternal({ type, amount, category, date, desc, linkedLoanId, isAuto: false, principalAmount: calculatedPrincipal > 0 ? calculatedPrincipal : amount }); saveData(); closeTxModal(); showToast('Transakce ulo≈æena'); 
        // Aktualizace graf≈Ø po ulo≈æen√≠ transakce
        updatePieChart(); 
        if (typeof updateBalanceChart === 'function') updateBalanceChart(12); 
        if (typeof initTrendChart === 'function') initTrendChart();
        if (typeof updateIncomeExpenseChart === 'function') updateIncomeExpenseChart();
        if (typeof updateTrendChart === 'function') updateTrendChart();
        if (typeof renderIncomeExpenseLineChart === 'function') renderIncomeExpenseLineChart();
        renderTransactionLists();
        }
        function deleteTransactionInternal(id) { const tx = AppState.transactions.find(t => t.id === id); if(!tx) return; if (tx.type === 'income') AppState.balance -= tx.amount; else AppState.balance += tx.amount; if (tx.linkedLoanId && tx.type === 'expense') { const loan = AppState.loans.find(l => l.id === tx.linkedLoanId); if (loan) loan.currentPrincipal += (tx.principalAmount !== undefined ? tx.principalAmount : tx.amount); } AppState.transactions = AppState.transactions.filter(t => t.id !== id); }
        function editTransaction(id) { const tx = AppState.transactions.find(t => t.id === id); if(!tx) return; editingTxId = id; document.getElementById('transType').value = tx.type; updateCategoryDropdown('trans'); document.getElementById('transAmount').value = tx.amount; document.getElementById('transDesc').value = tx.desc || ''; document.getElementById('transCategory').value = tx.category; document.getElementById('transDate').value = tx.date; checkTxLoanLinking(); if(tx.linkedLoanId) document.getElementById('transLinkedLoan').value = tx.linkedLoanId; openTxModal(true); }
        function deleteTransaction(id) { if(confirm("Smazat?")) { deleteTransactionInternal(id); saveData(); showToast('Transakce smaz√°na'); 
        // Aktualizace graf≈Ø po smaz√°n√≠ transakce
        updatePieChart(); 
        if (typeof updateBalanceChart === 'function') updateBalanceChart(12); 
        if (typeof initTrendChart === 'function') initTrendChart();
        if (typeof updateIncomeExpenseChart === 'function') updateIncomeExpenseChart();
        if (typeof updateTrendChart === 'function') updateTrendChart();
        if (typeof renderIncomeExpenseLineChart === 'function') renderIncomeExpenseLineChart();
        renderTransactionLists();
        }}
        
        function renderTransactionLists() { 
            const dashboardList = document.getElementById('dashboardTxList'); 
            const fullList = document.getElementById('fullTxList'); 
            dashboardList.innerHTML = ''; 
            fullList.innerHTML = ''; 

            const sortedTxs = [...AppState.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

            const currentMonthTxs = sortedTxs.filter(t => { const d = new Date(t.date); return d.getMonth() === viewDate.getMonth() && d.getFullYear() === viewDate.getFullYear(); }); 
            renderTxToContainer(dashboardList, currentMonthTxs.slice(0, AppState.transactionLimit || 5));

            const filterDateFrom = document.getElementById('filterDateFrom').value;
            const filterDateTo = document.getElementById('filterDateTo').value;
            const filterType = document.getElementById('filterType').value;

            let filteredTxs = sortedTxs;

            if (filterDateFrom) {
                filteredTxs = filteredTxs.filter(t => t.date >= filterDateFrom);
            }
            if (filterDateTo) {
                filteredTxs = filteredTxs.filter(t => t.date <= filterDateTo);
            }
            if (filterType !== 'all') {
                filteredTxs = filteredTxs.filter(t => t.type === filterType);
            }
            
            renderTxToContainer(fullList, filteredTxs);
        }

        function renderTxToContainer(container, transactions) {
            if(transactions.length === 0) { 
                container.innerHTML = '<div style="text-align:center; padding: 30px; color: var(--text-secondary); font-size: 0.9rem;">≈Ω√°dn√© transakce</div>'; 
                return; 
            } 
            transactions.forEach(tx => { 
                const isInc = tx.type === 'income'; 
                let catDisp = tx.category; 
                if(tx.linkedLoanId) catDisp += ` <small>(${AppState.loans.find(l=>l.id===tx.linkedLoanId)?.name||'√övƒõr'})</small>`; 
                const html = `<div class="list-item"><div><div class="item-main">${tx.desc || catDisp}</div><div class="item-sub"><span class="cat-tag">${tx.category}</span> ${new Date(tx.date).toLocaleDateString('cs-CZ')}</div></div><div style="display:flex;align-items:center;"><div class="amount ${isInc?'inc':'exp'}">${isInc?'+':'-'} ${formatMoney(tx.amount)}</div><div class="tx-actions" style="margin-left:10px; display: flex; gap: 10px;"><button class="btn-icon" onclick="editTransaction('${tx.id}')">‚úé</button><button class="btn-icon text-danger" onclick="deleteTransaction('${tx.id}')">‚úï</button></div></div></div>`; 
                container.innerHTML += html; 
            });
        }

        function applyFilters() {
            renderTransactionLists();
            showToast('Filtry aplikov√°ny');
        }

        function resetFilters() {
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
            
            document.getElementById('filterDateFrom').value = firstDay;
            document.getElementById('filterDateTo').value = lastDay;
            document.getElementById('filterType').value = 'all';
            renderTransactionLists();
            showToast('Filtry resetov√°ny na tento mƒõs√≠c');
        }

        // --- LOAN FUNCTIONS ---
        function showLoanCreationForm() { document.getElementById('loansOverviewSection').style.display='none'; document.getElementById('loanCreationCard').style.display='block'; }
        function hideLoanCreationForm() { document.getElementById('loanCreationCard').style.display='none'; document.getElementById('loansOverviewSection').style.display='block'; document.getElementById('useManualFirstPayment').checked=false; toggleManualPaymentFields(); }
        function closeLoanDetail() { document.getElementById('loanDetailCard').style.display='none'; document.getElementById('loansOverviewSection').style.display='block'; }
        function toggleManualPaymentFields() { document.getElementById('manualPaymentFields').style.display = document.getElementById('useManualFirstPayment').checked ? 'grid' : 'none'; }
        function createNewLoan() { const name = document.getElementById('newLoanName').value; const original = parseFloat(document.getElementById('newLoanOriginal').value); const current = parseFloat(document.getElementById('newLoanCurrent').value); const rate = parseFloat(document.getElementById('newLoanRate').value); const payment = parseFloat(document.getElementById('newLoanPayment').value); const disbursementDate = document.getElementById('newLoanDisbursementDate').value; const firstPaymentDate = document.getElementById('newLoanFirstPaymentDate').value; if(!name||isNaN(original)||isNaN(current)||isNaN(rate)||isNaN(payment)||!disbursementDate||!firstPaymentDate) { alert("Vypl≈àte z√°kladn√≠ √∫daje."); return; } let manualData = null; if(document.getElementById('useManualFirstPayment').checked) { const manTotal = parseFloat(document.getElementById('manualFirstTotal').value); const manInterest = parseFloat(document.getElementById('manualFirstInterest').value); if(isNaN(manTotal)||isNaN(manInterest)||manInterest>manTotal) { alert("Chyba v ruƒçn√≠ spl√°tce."); return; } manualData = { total: manTotal, interest: manInterest, principal: manTotal - manInterest }; } AppState.loans.push({ id: "l_"+Date.now(), name, originalAmount: original, currentPrincipal: current, interestRate: rate, monthlyPayment: payment, disbursementDate, firstPaymentDate, manualFirstPayment: manualData }); saveData(); hideLoanCreationForm(); document.querySelectorAll('#loanCreationCard input').forEach(i => i.value=''); showToast('√övƒõr p≈ôid√°n'); }
        
        
        function getRemainingTime(loan) {
            if (!loan.monthlyPayment || loan.monthlyPayment <= 0) {
                return 'Neurƒçeno';
            }
            
            const currentBalance = loan.currentPrincipal || 0;
            if (currentBalance <= 0) {
                return 'Splaceno';
            }
            
            const interestRate = (loan.interestRate || 0) / 100;
            const monthlyRate = interestRate / 12;
            
            let remainingMonths = 0;
            
            if (monthlyRate === 0 || monthlyRate < 0.0001) {
                // Bez √∫roku nebo zanedbateln√Ω √∫rok
                remainingMonths = Math.ceil(currentBalance / loan.monthlyPayment);
            } else {
                // S √∫rokem - pou≈æijeme vzorec pro anuitu
                // n = -log(1 - (P * r) / M) / log(1 + r)
                // P = aktu√°ln√≠ z≈Østatek, r = mƒõs√≠ƒçn√≠ √∫rok, M = mƒõs√≠ƒçn√≠ spl√°tka
                const numerator = 1 - (currentBalance * monthlyRate) / loan.monthlyPayment;
                if (numerator <= 0) {
                    // Spl√°tka je p≈ô√≠li≈° n√≠zk√° na pokryt√≠ √∫rok≈Ø
                    return 'Spl√°tka nedostateƒçn√°';
                }
                remainingMonths = Math.ceil(-Math.log(numerator) / Math.log(1 + monthlyRate));
            }
            
            if (!isFinite(remainingMonths) || remainingMonths < 0) {
                return 'Neurƒçeno';
            }
            
            const years = Math.floor(remainingMonths / 12);
            const months = remainingMonths % 12;
            
            let result = '';
            if (years > 0) {
                result += `${years} ${years === 1 ? 'rok' : years < 5 ? 'roky' : 'let'}`;
            }
            if (months > 0) {
                if (result) result += ' a ';
                result += `${months} ${months === 1 ? 'mƒõs√≠c' : months < 5 ? 'mƒõs√≠ce' : 'mƒõs√≠c≈Ø'}`;
            }
            
            return result || 'M√©nƒõ ne≈æ mƒõs√≠c';
        }

        function renderLoansOverview() { 
            const list = document.getElementById('loansList'); 
            list.innerHTML = ''; 
            let totalRemaining = 0; 
            let maxMonths = 0; 
            
            if(AppState.loans.length === 0) { 
                list.innerHTML = '<div style="text-align:center; padding: 40px; color: var(--text-secondary); font-size: 0.9rem;">≈Ω√°dn√© aktivn√≠ √∫vƒõry.</div>'; 
            } else { 
                AppState.loans.forEach(loan => { 
                    totalRemaining += loan.currentPrincipal; 
                    if (loan.currentPrincipal > 0 && loan.monthlyPayment > 0) { 
                        const estimatedMonths = loan.currentPrincipal / (loan.monthlyPayment * 0.6); 
                        if (estimatedMonths > maxMonths) maxMonths = estimatedMonths; 
                    } 
                    const paidTotal = loan.originalAmount - loan.currentPrincipal; 
                    const progress = Math.min((paidTotal / loan.originalAmount) * 100, 100) || 0;
                    const remainingTime = getRemainingTime(loan);
                    list.innerHTML += `<div class="loan-overview-item" onclick="showLoanDetails('${loan.id}')"><div style="display: flex; justify-content: space-between; margin-bottom:12px;"><strong style="font-size:1rem; color: var(--text-primary);">${loan.name}</strong><span class="text-danger font-bold" style="font-size:0.95rem;">${formatMoney(loan.currentPrincipal)}</span></div><div class="loan-progress-bg"><div class="loan-progress-fill" style="width: ${progress}%"></div></div><div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 6px;"><span>Splaceno: ${Math.round(progress)}%</span><span>Spl√°tka: ${formatMoney(loan.monthlyPayment)}</span></div><div style="display: flex; justify-content: center; font-size: 0.8rem;"><span style="color: var(--accent-cyan); font-weight: 600;">‚è± Zb√Ωv√°: ${remainingTime}</span></div></div>`; 
                }); 
            } 
            document.getElementById('totalLoansRemaining').textContent = formatMoney(totalRemaining); 
            let timeRemainingStr = "-"; 
            if (maxMonths > 0) { 
                const years = Math.floor(maxMonths / 12); 
                const months = Math.round(maxMonths % 12); 
                if (years > 0) timeRemainingStr = `${years}r ${months}m`; else timeRemainingStr = `${months} mƒõs√≠c≈Ø`; 
                if (years > 30) timeRemainingStr = "30+ let"; 
            } 
            document.getElementById('maxLoanTimeRemaining').textContent = timeRemainingStr; 

            calculateAndRenderLoanMonthlySummary();
        }

        function calculateAndRenderLoanMonthlySummary() {
            const now = new Date();
            const thisMonthRepayments = AppState.transactions.filter(t => {
                const d = new Date(t.date);
                return t.type === 'expense' &&
                       t.linkedLoanId && 
                       d.getMonth() === now.getMonth() &&
                       d.getFullYear() === now.getFullYear();
            });

            let total = 0;
            let principal = 0;

            thisMonthRepayments.forEach(t => {
                total += t.amount;
                principal += (t.principalAmount || 0);
            });

            const interest = total - principal;

            document.getElementById('loanSumTotal').innerText = formatMoney(total).replace('Kƒç','').trim();
            document.getElementById('loanSumPrincipal').innerText = formatMoney(principal).replace('Kƒç','').trim();
            document.getElementById('loanSumInterest').innerText = formatMoney(interest).replace('Kƒç','').trim();
        }


        function showLoanDetails(loanId) { const loan = AppState.loans.find(l => l.id === loanId); if(!loan) return; editingLoanId = loanId; document.getElementById('detailLoanName').textContent = loan.name; document.getElementById('detailRemainingTop').textContent = formatMoney(loan.currentPrincipal); document.getElementById('detailTerms').textContent = `P≈Øvodn√≠ v√Ω≈°e: ${formatMoney(loan.originalAmount)} ‚Ä¢ √örok: ${loan.interestRate}% p.a.`; const paidTotal = loan.originalAmount - loan.currentPrincipal; document.getElementById('detailPaidTotal').textContent = formatMoney(paidTotal); const progress = Math.min((paidTotal / loan.originalAmount) * 100, 100) || 0; document.getElementById('detailProgressBar').style.width = `${progress}%`; document.getElementById('detailProgressText').textContent = `${Math.round(progress)}%`; renderLoanSchedule(loan); document.getElementById('loansOverviewSection').style.display='none'; document.getElementById('loanDetailCard').style.display='block'; window.scrollTo(0,0); }
        function openLoanEditModal() { const loan = AppState.loans.find(l => l.id === editingLoanId); if(!loan) return; document.getElementById('editLoanId').value = loan.id; document.getElementById('editLoanName').value = loan.name; document.getElementById('editLoanRate').value = loan.interestRate; document.getElementById('editLoanPayment').value = loan.monthlyPayment; document.getElementById('loanEditModal').classList.add('active'); }
        function closeLoanEditModal() { document.getElementById('loanEditModal').classList.remove('active'); }
        function saveLoanEdit() { const id = document.getElementById('editLoanId').value; const name = document.getElementById('editLoanName').value; const rate = parseFloat(document.getElementById('editLoanRate').value); const payment = parseFloat(document.getElementById('editLoanPayment').value); if(!name || isNaN(rate) || isNaN(payment)) { alert("Vypl≈àte platn√© √∫daje."); return; } const loanIdx = AppState.loans.findIndex(l => l.id === id); if(loanIdx > -1) { AppState.loans[loanIdx].name = name; AppState.loans[loanIdx].interestRate = rate; AppState.loans[loanIdx].monthlyPayment = payment; saveData(); closeLoanEditModal(); showLoanDetails(id); showToast('√övƒõr upraven'); } }
        function deleteLoanById(loanId) { if(!confirm('Opravdu smazat √∫vƒõr? Sma≈æou se i p≈ôi≈ôazen√© transakce.')) return; const loanIdx = AppState.loans.findIndex(l => l.id === loanId); if(loanIdx > -1) { AppState.loans.splice(loanIdx, 1); AppState.transactions = AppState.transactions.filter(t => t.linkedLoanId !== loanId); saveData(); closeLoanDetail(); renderLoansOverview(); showToast('√övƒõr smaz√°n'); } }
        function renderLoanSchedule(loan) { const list = document.getElementById('loanScheduleList'); list.innerHTML = ''; let balance = loan.originalAmount; const monthlyRate = (loan.interestRate/100)/12; const currentActual = loan.currentPrincipal; const now = new Date(); const todayNorm = new Date(now.getFullYear(), now.getMonth(), now.getDate()); let nextPayDate = new Date(loan.firstPaymentDate); const loanPayments = AppState.transactions.filter(t => t.type === 'expense' && t.linkedLoanId === loan.id); const historicallyPaidPrincipal = loan.originalAmount - loan.currentPrincipal; let cumulativeScheduledPrincipal = 0; let idx = 1; if (loan.manualFirstPayment) { balance -= loan.manualFirstPayment.principal; cumulativeScheduledPrincipal += loan.manualFirstPayment.principal; renderScheduleCard(list, idx++, nextPayDate, loan.manualFirstPayment.total, loan.manualFirstPayment.interest, loan.manualFirstPayment.principal, balance, currentActual, todayNorm, loanPayments, historicallyPaidPrincipal, cumulativeScheduledPrincipal, true); } else { const d1 = new Date(loan.disbursementDate); const d2 = new Date(loan.firstPaymentDate); const days = Math.floor((Date.UTC(d2.getFullYear(), d2.getMonth(), d2.getDate()) - Date.UTC(d1.getFullYear(), d1.getMonth(), d1.getDate())) / (1000*60*60*24)); const dailyRate = (loan.interestRate/100)/365; let interest = balance*dailyRate*days; let principal = loan.monthlyPayment - interest; let total = loan.monthlyPayment; if(principal<0) { principal=0; total=interest; } balance -= principal; cumulativeScheduledPrincipal += principal; renderScheduleCard(list, idx++, nextPayDate, total, interest, principal, balance, currentActual, todayNorm, loanPayments, historicallyPaidPrincipal, cumulativeScheduledPrincipal); } for(let i=0; i<480 && balance > 10; i++) { nextPayDate.setMonth(nextPayDate.getMonth()+1); let interest = balance*monthlyRate; let principal = loan.monthlyPayment-interest; let total = loan.monthlyPayment; if(balance<principal) { principal=balance; total=interest+principal; } balance-=principal; cumulativeScheduledPrincipal += principal; renderScheduleCard(list, idx++, nextPayDate, total, interest, principal, balance, currentActual, todayNorm, loanPayments, historicallyPaidPrincipal, cumulativeScheduledPrincipal); } if (loan.currentPrincipal <= 10) { list.innerHTML += `<div style="margin-top: 24px; padding: 20px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; text-align: center;"><div style="color: var(--accent-green); font-size: 1.2rem; font-weight: 700; margin-bottom: 16px;">üéâ Gratuluju, p≈Øjƒçka zaplacena! üéâ</div><button class="btn" style="background: var(--accent-red); color: white; border: none; font-weight: 600;" onclick="deleteLoanById('${loan.id}')">Nyn√≠ m≈Ø≈æe≈° p≈Øjƒçku smazat</button></div>`; } }
        function renderScheduleCard(container, index, date, total, interest, principal, balance, actual, today, realPaymentsList, historicalLimit, currentCumulative, isMan=false) { const foundRealPayment = realPaymentsList.some(t => { const tDate = new Date(t.date); return tDate.getMonth() === date.getMonth() && tDate.getFullYear() === date.getFullYear(); }); const isHistoricalPayment = currentCumulative <= (historicalLimit + 0.01); const isPaid = isMan || foundRealPayment || isHistoricalPayment; const statusClass = isPaid ? 'is-paid' : 'is-plan'; const statusIcon = isPaid ? '‚úÖ' : '‚è≥'; const statusText = isPaid ? 'ZAPL.' : 'PL√ÅN'; const statusColorClass = isPaid ? 'paid' : 'plan'; const formatSimple = (n) => new Intl.NumberFormat('cs-CZ', {maximumFractionDigits:0}).format(n); container.innerHTML += `<div class="schedule-card ${statusClass}"><div class="sc-index">${index}</div><div class="sc-date-status"><div class="sc-date">${date.toLocaleDateString('cs-CZ', {month:'numeric', year:'numeric'})}</div><div class="sc-status ${statusColorClass}"><span>${statusIcon}</span>${statusText} ${isMan?'(Ruƒçnƒõ)':''}</div></div><div class="sc-breakdown"><div>Jist: <span>${formatSimple(principal)}</span></div><div>√örok: <span>${formatSimple(interest)}</span></div></div><div class="sc-debt"><div class="sc-debt-label">Dluh:</div><div class="sc-debt-amount">${formatSimple(Math.max(0, balance))}</div></div></div>`; }

        // --- SETTINGS & TEMPLATES ---
        function toggleSettingsCard(headerElement) {
            const card = headerElement.parentElement;
            card.classList.toggle('active');
        }

        // UPRAVENO: Funkce pro ulo≈æen√≠ nastaven√≠ viditelnosti anal√Ωz
        function saveAnalysisSettings() {
            const toggles = document.querySelectorAll('.analysis-toggle');
            toggles.forEach(toggle => {
                const toolName = toggle.getAttribute('data-tool');
                AppState.analysisSettings[toolName] = toggle.checked;
            });
            saveData();
            showToast('Nastaven√≠ zobrazen√≠ ulo≈æeno');
        }

        function saveTransactionLimit() {
            const input = document.getElementById('transactionLimitInput');
            const value = parseInt(input.value);
            if (value >= 1 && value <= 50) {
                AppState.transactionLimit = value;
                saveData();
                showToast('Poƒçet transakc√≠ ulo≈æen');
            } else {
                alert('Zadejte ƒç√≠slo mezi 1 a 50');
            }
        }

        // UPRAVENO: Funkce pro nastaven√≠ checkbox≈Ø podle ulo≈æen√©ho stavu
        function updateAnalysisSettingsUI() {
            const toggles = document.querySelectorAll('.analysis-toggle');
            toggles.forEach(toggle => {
                const toolName = toggle.getAttribute('data-tool');
                if (AppState.analysisSettings && AppState.analysisSettings[toolName] !== undefined) {
                    toggle.checked = AppState.analysisSettings[toolName];
                }
            });
        }

        function setManualBalance() { const val = parseFloat(document.getElementById('setBalanceInput').value); if(!isNaN(val)) { AppState.balance = val; saveData(); showToast('Z≈Østatek aktualizov√°n'); } }
        function settingsAddCategory() { 
            const name=document.getElementById('setNewCatName').value.trim(); 
            const type=document.getElementById('setNewCatType').value; 
            if(!name||AppState.categories[type].includes(name)) return; 
            AppState.categories[type].push(name); 
            // UPRAVENO: P≈ôid√°n√≠ n√°hodn√© barvy pro novou kategorii
            AppState.categoryColors[name] = '#' + Math.floor(Math.random()*16777215).toString(16);
            saveData(); 
            document.getElementById('setNewCatName').value=''; 
            renderSettingsCategories(); 
            showToast('Kategorie p≈ôid√°na'); 
        }
        function settingsRemoveCategory(type, name) { 
            if(type==='expense'&&name==='P≈Øjƒçka')return; 
            if(confirm("Smazat?")) { 
                AppState.categories[type]=AppState.categories[type].filter(c=>c!==name); 
                // UPRAVENO: Odebr√°n√≠ barvy
                delete AppState.categoryColors[name];
                saveData(); 
                renderSettingsCategories(); 
                showToast('Kategorie smaz√°na'); 
            }
        }
        
        function editCategory(type, oldName) {
            const newName = prompt(`Upravit kategorii "${oldName}":`, oldName);
            if (!newName || newName.trim() === '' || newName === oldName) return;
            
            const trimmedNew = newName.trim();
            
            // Kontrola, zda nov√° kategorie ji≈æ neexistuje
            if (AppState.categories[type].includes(trimmedNew)) {
                showToast('Tato kategorie ji≈æ existuje', 'error');
                return;
            }
            
            // Najdeme index star√© kategorie
            const index = AppState.categories[type].indexOf(oldName);
            if (index === -1) return;
            
            // Aktualizujeme kategorii
            AppState.categories[type][index] = trimmedNew;
            
            // Aktualizujeme v≈°echny transakce s touto kategori√≠
            AppState.transactions = AppState.transactions.map(t => {
                if (t.category === oldName && t.type === type) {
                    t.category = trimmedNew;
                }
                return t;
            });
            
            // Aktualizujeme ≈°ablony (trval√© platby)
            if (AppState.templates) {
                AppState.templates = AppState.templates.map(tmpl => {
                    if (tmpl.cat === oldName && tmpl.type === type) {
                        tmpl.cat = trimmedNew;
                    }
                    return tmpl;
                });
            }
            
            // Aktualizujeme limity kategori√≠
            if (AppState.categoryLimits[oldName] !== undefined) {
                AppState.categoryLimits[trimmedNew] = AppState.categoryLimits[oldName];
                delete AppState.categoryLimits[oldName];
            }
            
            // Aktualizujeme barvy kategori√≠
            if (AppState.categoryColors[oldName] !== undefined) {
                AppState.categoryColors[trimmedNew] = AppState.categoryColors[oldName];
                delete AppState.categoryColors[oldName];
            }
            
            // Aktualizujeme skryt√© kategorie
            if (AppState.hiddenBudgetCategories && AppState.hiddenBudgetCategories.includes(oldName)) {
                const hiddenIndex = AppState.hiddenBudgetCategories.indexOf(oldName);
                AppState.hiddenBudgetCategories[hiddenIndex] = trimmedNew;
            }
            
            saveData();
            renderSettingsCategories();
            showToast('Kategorie aktualizov√°na', 'success');
        }
        
        // UPRAVENO: Funkce pro zmƒõnu barvy kategorie
        function updateCategoryColor(catName, newColor) {
            AppState.categoryColors[catName] = newColor;
            saveData();
            // Pokud jsme na dashboardu, aktualizujeme graf
            if(document.getElementById('dashboard').classList.contains('active')) {
                renderDashboardBudgetOverview();
            }
             // Pokud jsme v grafech, aktualizujeme hlavn√≠ graf
            if(document.getElementById('charts').classList.contains('active')) {
                updatePieChart();
            }
        }

        function renderSettingsCategories() { 
            ['expense','income'].forEach(type=>{ 
                const list=document.getElementById('setCatList'+(type=='expense'?'Expense':'Income')); 
                list.innerHTML=''; 
                AppState.categories[type].forEach((cat, idx)=>{ 
                    const color = AppState.categoryColors[cat] || '#cccccc';
                    list.innerHTML+=`
                        <div class="list-item cat-sort-item" data-type="${type}" data-idx="${idx}" style="padding:10px 0; display: flex; align-items: center; justify-content: space-between; touch-action: none;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="cat-drag-handle" style="cursor:grab; font-size:1.1rem; color:var(--text-secondary); padding:4px 6px; user-select:none;" title="P≈ôet√°hnƒõte pro zmƒõnu po≈ôad√≠">‚†ø</span>
                                <input type="color" value="${color}" onchange="updateCategoryColor('${cat}', this.value)" style="border: none; background: none; width: 28px; height: 28px; cursor: pointer; padding: 0;">
                                <span style="font-weight:600;">${cat}</span>
                            </div>
                            <div style="display: flex; gap: 4px;">
                                <button class="btn-icon text-primary" style="padding:6px;width:30px;height:30px;" onclick="editCategory('${type}','${cat}')">‚úèÔ∏è</button>
                                ${(type!=='expense'||cat!=='P≈Øjƒçka')?`<button class="btn-icon text-danger" style="padding:6px;width:30px;height:30px;" onclick="settingsRemoveCategory('${type}','${cat}')">‚úï</button>`:''}
                            </div>
                        </div>`; 
                }); 
                initCatDragDrop(list, type);
            });

            const limitsList = document.getElementById('categoryLimitsSettingsList');
            limitsList.innerHTML = '';
            AppState.categories.expense.forEach(cat => {
                const currentLimit = AppState.categoryLimits[cat] || '';
                const isHidden = AppState.hiddenBudgetCategories.includes(cat);
                limitsList.innerHTML += `
                    <div class="form-group" style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <label class="form-label" style="margin-bottom: 0;">${cat}</label>
                            <label style="font-size: 0.75rem; display: flex; align-items: center; gap: 6px; cursor: pointer; color: var(--text-secondary);">
                                <input type="checkbox" class="visibility-toggle" data-cat="${cat}" ${!isHidden ? 'checked' : ''} style="accent-color: var(--accent-blue);">
                                Zobrazit v p≈ôehledu
                            </label>
                        </div>
                        <input type="number" class="form-input category-limit-input" data-cat="${cat}" value="${currentLimit}" placeholder="Limit (Kƒç)" min="0" inputmode="decimal">
                    </div>
                `;
            });
        }

        function saveAllCategoryLimits() {
            const inputs = document.querySelectorAll('.category-limit-input');
            inputs.forEach(input => {
                const cat = input.getAttribute('data-cat');
                const val = parseFloat(input.value);
                if (!isNaN(val) && val > 0) {
                    AppState.categoryLimits[cat] = val;
                } else {
                    delete AppState.categoryLimits[cat];
                }
            });

            const newHiddenCategories = [];
            document.querySelectorAll('.visibility-toggle').forEach(toggle => {
                if (!toggle.checked) {
                    newHiddenCategories.push(toggle.getAttribute('data-cat'));
                }
            });
            AppState.hiddenBudgetCategories = newHiddenCategories;

            saveData();
            showToast('Limity a nastaven√≠ ulo≈æeny');
            
            if(document.getElementById('dashboard').classList.contains('active')) {
                renderDashboardBudgetOverview();
            }
        }

        function addTemplate() { const desc = document.getElementById('templDesc').value; const amount = parseFloat(document.getElementById('templAmount').value); const day = parseInt(document.getElementById('templDay').value); const cat = document.getElementById('templCategory').value; const type = document.getElementById('templType').value; if(desc && !isNaN(amount) && day && day >= 1 && day <= 31) { AppState.templates.push({id:Date.now(), desc, amount, cat, day, type}); saveData(); document.getElementById('templDesc').value=''; document.getElementById('templAmount').value=''; document.getElementById('templDay').value=''; renderTemplates(); showToast('≈†ablona p≈ôid√°na'); } else { alert("Vypl≈àte platn√© √∫daje (den 1-31)."); } }
        function deleteTemplate(id) { if(confirm('Smazat ≈°ablonu?')) { AppState.templates = AppState.templates.filter(t => t.id !== id); saveData(); renderTemplates(); showToast('≈†ablona smaz√°na'); } }
        function renderTemplates() { const list = document.getElementById('templateList'); list.innerHTML = ''; AppState.templates.sort((a,b)=>a.day-b.day).forEach(t => { const linkedLoan = AppState.loans.find(l => l.name.toLowerCase().trim() === t.desc.toLowerCase().trim()); list.innerHTML += `<div class="list-item"><div><div class="item-main">${t.desc}${linkedLoan ? ` <span class="linked-badge" style="font-weight:600;">üîó ${linkedLoan.name}</span>` : ''}</div><div class="item-sub">Den: ${t.day}. | <span class="cat-tag">${t.cat}</span> (${t.type === 'income' ? 'P≈ô√≠jem' : 'V√Ωdaj'})</div><div style="margin-top:4px; font-weight:700;" class="${t.type === 'income' ? 'text-success' : 'text-danger'}">${formatMoney(t.amount)}</div></div><div style="display: flex; gap: 4px;"><button class="btn-icon" style="color: var(--accent-blue);" onclick="editTemplate(${t.id})">‚úèÔ∏è</button><button class="btn-icon text-danger" onclick="deleteTemplate(${t.id})">‚úï</button></div></div>`; }); }
        
        function editTemplate(id) {
            const t = AppState.templates.find(tmpl => tmpl.id === id);
            if (!t) return;
            
            // Vypln√≠me formul√°≈ô
            document.getElementById('templType').value = t.type;
            document.getElementById('templDesc').value = t.desc;
            document.getElementById('templAmount').value = t.amount;
            document.getElementById('templDay').value = t.day;
            updateCategoryDropdown('templ');
            document.getElementById('templCategory').value = t.cat;
            
            // Zmƒõn√≠me tlaƒç√≠tko
            const addBtn = document.getElementById('addTemplateBtn');
            addBtn.textContent = 'Ulo≈æit zmƒõny';
            addBtn.onclick = function() { updateTemplate(id); };
            
            // P≈ôid√°me tlaƒç√≠tko zru≈°it
            let cancelBtn = document.getElementById('cancelEditTemplate');
            if (!cancelBtn) {
                cancelBtn = document.createElement('button');
                cancelBtn.id = 'cancelEditTemplate';
                cancelBtn.className = 'btn btn-secondary';
                cancelBtn.textContent = 'Zru≈°it';
                cancelBtn.style.marginTop = '8px';
                cancelBtn.onclick = cancelEditTemplate;
                addBtn.parentNode.appendChild(cancelBtn);
            }
            
            // Scroll na formul√°≈ô
            const settingsCard = addBtn.closest('.settings-card');
            if (settingsCard && !settingsCard.classList.contains('active')) {
                settingsCard.classList.add('active');
            }
            addBtn.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function updateTemplate(id) {
            const t = AppState.templates.find(tmpl => tmpl.id === id);
            if (!t) return;
            
            const desc = document.getElementById('templDesc').value;
            const amount = parseFloat(document.getElementById('templAmount').value);
            const day = parseInt(document.getElementById('templDay').value);
            const cat = document.getElementById('templCategory').value;
            const type = document.getElementById('templType').value;
            
            if(desc && !isNaN(amount) && day && day >= 1 && day <= 31) {
                t.desc = desc;
                t.amount = amount;
                t.day = day;
                t.cat = cat;
                t.type = type;
                
                saveData();
                cancelEditTemplate();
                showToast('≈†ablona aktualizov√°na');
            } else {
                alert("Vypl≈àte platn√© √∫daje (den 1-31).");
            }
        }
        
        function cancelEditTemplate() {
            document.getElementById('templDesc').value = '';
            document.getElementById('templAmount').value = '';
            document.getElementById('templDay').value = '';
            
            const addBtn = document.getElementById('addTemplateBtn');
            addBtn.textContent = 'P≈ôidat ≈°ablonu';
            addBtn.onclick = addTemplate;
            
            const cancelBtn = document.getElementById('cancelEditTemplate');
            if (cancelBtn) {
                cancelBtn.remove();
            }
            
            renderTemplates();
        }
        
        function applyMonthly() { if(confirm('Vlo≈æit trval√© platby pro tento mƒõs√≠c?')) { processTemplatesForMonth(viewDate.getMonth(), viewDate.getFullYear()); showToast('Platby vlo≈æeny'); } }

        function checkDailyStandingOrders() {
            const today = new Date();
            const currentDay = today.getDate();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            let processedCount = 0;

            const todayTemplates = AppState.templates.filter(t => t.day === currentDay);

            todayTemplates.forEach(templ => {
                const alreadyExists = AppState.transactions.some(tx => {
                    const txDate = new Date(tx.date);
                    return txDate.getMonth() === currentMonth && 
                           txDate.getFullYear() === currentYear &&
                           tx.isAuto === true &&
                           tx.desc === templ.desc &&
                           tx.amount === templ.amount &&
                           tx.type === templ.type;
                });

                if (!alreadyExists) {
                    const dStr = today.toISOString().split('T')[0];
                    let loanId = null; let calculatedPrincipal = 0;
                    const loan = AppState.loans.find(l => l.name.toLowerCase().trim() === templ.desc.toLowerCase().trim());
                    if (loan && templ.type === 'expense') {
                         loanId = loan.id;
                         const interest = loan.currentPrincipal * (loan.interestRate/100/12);
                         calculatedPrincipal = Math.min(loan.currentPrincipal, templ.amount - interest);
                    }
                    createTransactionInternal({ id: "tx_auto_" + Date.now() + Math.random(), date: dStr, type: templ.type, desc: templ.desc, amount: templ.amount, category: templ.cat, linkedLoanId: loanId, isAuto: true, principalAmount: calculatedPrincipal > 0 ? templ.amount : 0 });
                    processedCount++;
                }
            });

            if (processedCount > 0) {
                saveData();
                showToast(`Automatick√© platby provedeny (${processedCount})`);
            }
        }

        function processTemplatesForMonth(month, year) {
             AppState.templates.forEach(s => { 
                 let dStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(s.day).padStart(2, '0')}`; 
                 let loanId = null; let calculatedPrincipal = 0; 
                 const loan = AppState.loans.find(l => l.name.toLowerCase().trim() === s.desc.toLowerCase().trim()); 
                 if (loan && s.type === 'expense') { 
                     loanId = loan.id; 
                     const interest = loan.currentPrincipal * (loan.interestRate/100/12); 
                     calculatedPrincipal = Math.min(loan.currentPrincipal, s.amount - interest); 
                 } 
                 createTransactionInternal({ id: "tx_auto_" + Date.now() + Math.random(), date: dStr, type: s.type, desc: s.desc, amount: s.amount, category: s.cat, linkedLoanId: loanId, isAuto: true, principalAmount: calculatedPrincipal > 0 ? s.amount : 0 }); 
            }); 
            saveData();
        }


        function exportData() {
            var filename = 'smartbudget_' + new Date().toISOString().split('T')[0] + '.json';
            var json = JSON.stringify(AppState);
            // Android WebView - pou≈æij native bridge
            if (window.AndroidBridge && window.AndroidBridge.saveFile) {
                window.AndroidBridge.saveFile(filename, json);
                showToast('Z√°loha ulo≈æena do St≈æen√© soubory');
                return;
            }
            // Fallback pro prohl√≠≈æeƒç
            try {
                var blob = new Blob([json], {type:'application/json'});
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url; a.download = filename;
                document.body.appendChild(a); a.click();
                setTimeout(function(){ document.body.removeChild(a); URL.revokeObjectURL(url); }, 300);
                showToast('Z√°loha sta≈æena');
            } catch(e) {
                showToast('Chyba exportu: ' + e.message);
            }
        }
        function importData(e) { var r=new FileReader(); r.onload=function(ev){ try{ AppState=JSON.parse(ev.target.result); localStorage.setItem(STORAGE_KEY,JSON.stringify(AppState)); updateUI(); // Zniƒçit star√© instance graf≈Ø aby se p≈ôekreslily ƒçistƒõ
            if(typeof expenseChartInstance!=='undefined'&&expenseChartInstance){try{expenseChartInstance.destroy();}catch(ex){} expenseChartInstance=null;}
            if(typeof balanceChartInstance!=='undefined'&&balanceChartInstance){try{balanceChartInstance.destroy();}catch(ex){} balanceChartInstance=null;}
            if(typeof incomeExpenseLineChartInstance!=='undefined'&&incomeExpenseLineChartInstance){try{incomeExpenseLineChartInstance.destroy();}catch(ex){} incomeExpenseLineChartInstance=null;}
            pieChartMode = 'overall';
            setTimeout(function(){
                try{initTrendChart();}catch(ex){}
                try{
                    // Nastav select na 'overall' p≈ôed p≈ôekreslen√≠m
                    var ps=document.getElementById('pieChartModeSelect');
                    if(ps){ ps.value='overall'; }
                    updatePieChart();
                }catch(ex){}
                try{updateBalanceChart(12);}catch(ex){}
                try{var s=document.getElementById('incomeExpenseYearSelect'); renderIncomeExpenseLineChart(s?parseInt(s.value):new Date().getFullYear());}catch(ex){}
            },250); showToast('Z√°loha naƒçtena'); }catch(ex){ alert('Chyba importu.'); } }; r.readAsText(e.target.files[0]); }
        function checkTxLoanLinking() { const type=document.getElementById('transType').value; const cat=document.getElementById('transCategory').value; const section=document.getElementById('transLoanLinkSection'); const select=document.getElementById('transLinkedLoan'); if(type==='expense' && cat==='P≈Øjƒçka' && AppState.loans.length>0) { section.style.display='block'; if(select.options.length<=1) { select.innerHTML='<option value="">-- Vyberte √∫vƒõr --</option>'; AppState.loans.filter(l=>l.currentPrincipal>0).forEach(l=>{select.innerHTML+=`<option value="${l.id}">${l.name}</option>`}); } } else { section.style.display='none'; select.value=""; }}
        
        // --- CHARTS & FORMATTING ---
        function formatMoney(a) { return new Intl.NumberFormat('cs-CZ',{style:'currency',currency:'CZK',maximumFractionDigits:0}).format(a); }
        function switchPieMode(mode, btn) { pieChartMode = mode; btn.parentNode.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); updatePieChart(); }
        
        // Nov√© funkce pro chart-selecty
        function switchPieModeFromSelect(mode) {
            // Pokud je mode "overall", nech√°me ho jako string
            // Pokud je to rok (ƒç√≠slo), p≈ôevedeme na ƒç√≠slo
            if (mode === 'overall') {
                pieChartMode = 'overall';
            } else if (!isNaN(mode)) {
                pieChartMode = parseInt(mode);
            } else {
                pieChartMode = mode;
            }
            updatePieChart();
        }
        
        function updateBalanceChartFromSelect() {
            const period = parseInt(document.getElementById('balancePeriodSelect').value);
            const yearValue = document.getElementById('balanceYearSelect').value;
            
            let year = null;
            if (yearValue !== 'current' && !isNaN(yearValue)) {
                year = parseInt(yearValue);
            }
            
            updateBalanceChart(period, null, year);
        }
        
        function renderDashboardBudgetOverview() {
            const currentMonthExpTxs = AppState.transactions.filter(t => { 
                const d = new Date(t.date); 
                return t.type === 'expense' && d.getMonth() === viewDate.getMonth() && d.getFullYear() === viewDate.getFullYear(); 
            });
            
            const categorySpending = {};
            currentMonthExpTxs.forEach(t => {
                categorySpending[t.category] = (categorySpending[t.category] || 0) + t.amount;
            });

            const chartContainerElement = document.querySelector('#dashboard .chart-container.small');
            if (chartContainerElement) {
                if (dashboardMonthPieChartInstance) dashboardMonthPieChartInstance.destroy();
                
                chartContainerElement.innerHTML = '<canvas id="dashboardMonthPieChart"></canvas>';
                const ctx = document.getElementById('dashboardMonthPieChart');

                // Se≈ôad√≠me data od nejvy≈°≈°√≠ho po nejni≈æ≈°√≠
                const sortedEntries = Object.entries(categorySpending).sort((a, b) => b[1] - a[1]);
                const dataLabels = sortedEntries.map(e => e[0]);
                const dataValues = sortedEntries.map(e => e[1]);
                
                // Pou≈æit√≠ barev z nastaven√≠
                const backgroundColors = dataLabels.map(cat => AppState.categoryColors[cat] || '#cccccc');

                if (dataValues.length === 0 || dataValues.reduce((a,b)=>a+b, 0) === 0) {
                     chartContainerElement.innerHTML = '<div style="height:100%;display:flex;align-items:center;justify-content:center;color:var(--text-secondary);font-size:0.8rem;">≈Ω√°dn√© v√Ωdaje tento mƒõs√≠c</div>';
                } else {
                    dashboardMonthPieChartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: dataLabels,
                            datasets: [{ 
                                data: dataValues, 
                                backgroundColor: backgroundColors, 
                                borderWidth: 2,
                                borderColor: '#121212',
                                hoverOffset: 12,
                                hoverBorderWidth: 3,
                                hoverBorderColor: '#ffffff'
                            }]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false,
                            animation: {
                                animateRotate: true,
                                animateScale: true,
                                duration: 1000,
                                easing: 'easeOutQuart'
                            },
                            plugins: { 
                                legend: { 
                                    display: true, 
                                    position: 'bottom', 
                                    labels: {
                                        usePointStyle: true,
                                        font: { family: 'Inter', size: 10, weight: '600' },
                                        color: '#ffffff',
                                        padding: 12,
                                        boxWidth: 10,
                                        boxHeight: 10,
                                        generateLabels: function(chart) {
                                            const data = chart.data;
                                            if (data.labels.length && data.datasets.length) {
                                                const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                                return data.labels.map((label, i) => {
                                                    const value = data.datasets[0].data[i];
                                                    const percentage = ((value / total) * 100).toFixed(0) + '%';
                                                    return {
                                                        text: `${label} (${percentage})`,
                                                        fillStyle: data.datasets[0].backgroundColor[i],
                                                        hidden: chart.getDatasetMeta(0).data[i].hidden,
                                                        index: i,
                                                        fontColor: '#ffffff',
                                                        pointStyle: 'circle'
                                                    };
                                                });
                                            }
                                            return [];
                                        }
                                    },
                                    onClick: function(e, legendItem, legend) {
                                        const index = legendItem.index;
                                        const chart = legend.chart;
                                        const meta = chart.getDatasetMeta(0);
                                        meta.data[index].hidden = !meta.data[index].hidden;
                                        chart.update();
                                    }
                                }, 
                                tooltip: { 
                                    backgroundColor: 'rgba(18, 18, 18, 0.95)',
                                    titleColor: '#fff',
                                    titleFont: {family:'Inter', size: 12, weight: 'bold'},
                                    bodyColor: '#a0a0a0',
                                    bodyFont: {family:'Inter', size: 11},
                                    borderColor: '#333',
                                    borderWidth: 1,
                                    padding: 12,
                                    displayColors: true,
                                    boxPadding: 5,
                                    callbacks: { 
                                        label: function(c) {
                                            const total = c.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((c.parsed / total) * 100).toFixed(1);
                                            return ` ${c.label}: ${formatMoney(c.parsed)} (${percentage}%)`;
                                        }
                                    } 
                                } 
                            }, 
                            cutout: '68%' 
                        }
                    });
                }
            }

            const container = document.getElementById('dashboardBudgetOverview');
            container.innerHTML = '';
            
            let sortedCategories = [...AppState.categories.expense].sort((a, b) => {
                const limitA = AppState.categoryLimits[a] || 0;
                const limitB = AppState.categoryLimits[b] || 0;
                const spentA = categorySpending[a] || 0;
                const spentB = categorySpending[b] || 0;

                if (limitA > 0 && limitB > 0) {
                    return (spentB / limitB) - (spentA / limitA);
                }
                if (limitA > 0) return -1;
                if (limitB > 0) return 1;
                return spentB - spentA;
            });

            let hasLimits = false;
            sortedCategories.forEach(cat => {
                if (AppState.hiddenBudgetCategories.includes(cat)) {
                    return;
                }

                const spent = categorySpending[cat] || 0;
                const limit = AppState.categoryLimits[cat] || 0;
                
                if (limit > 0) {
                    hasLimits = true;
                    const percentage = (spent / limit) * 100;
                    const remaining = limit - spent;
                    
                    let barColor = 'green';
                    let detailsText = '';

                    if (percentage >= 100) {
                        barColor = 'red';
                        detailsText = `<span class="text-danger" style="font-weight:700;">P≈ôeƒçerp√°no: ${formatMoney(Math.abs(remaining))}</span>`;
                    } else if (percentage >= 75) {
                        barColor = 'yellow';
                        detailsText = `Zb√Ωv√°: ${formatMoney(remaining)}`;
                    } else {
                        detailsText = `Zb√Ωv√°: ${formatMoney(remaining)}`;
                    }

                    container.innerHTML += `
                        <div class="budget-item">
                            <div class="budget-header">
                                <span>${cat}</span>
                                <span>${formatMoney(spent)} / ${formatMoney(limit)}</span>
                            </div>
                            <div class="budget-progress-container">
                                <div class="budget-bar ${barColor}" style="width: ${Math.min(percentage, 100)}%"></div>
                            </div>
                            <div class="budget-details">
                                <span>${percentage.toFixed(0)} %</span>
                                <span>${detailsText}</span>
                            </div>
                        </div>
                    `;
                }
            });

            if (!hasLimits) {
                container.innerHTML = '<p style="text-align:center; color:var(--text-secondary); font-size:0.8rem; padding: 10px;">Nem√°te nastaveny ≈æ√°dn√© viditeln√© limity kategori√≠. Nastavte je v sekci Nastaven√≠.</p>';
            }
        }

        // UPRAVENO: Pozice legendy na 'bottom' a pou≈æit√≠ nastaven√Ωch barev
        function updatePieChart() {
            const pieSelect = document.getElementById('pieChartModeSelect');
            if (pieSelect) {
                const years = new Set();
                AppState.transactions.forEach(t => {
                    years.add(new Date(t.date).getFullYear());
                });
                const sortedYears = Array.from(years).sort((a, b) => b - a);

                // Zachovat aktu√°ln√≠ v√Ωbƒõr (FIX: spr√°vnƒõ zachovat 'overall')
                const currentValue = pieSelect.value || pieChartMode;
                pieSelect.innerHTML = '<option value="overall">Celkovƒõ (v≈°e)</option>';
                sortedYears.forEach(year => {
                    pieSelect.innerHTML += `<option value="${year}">${year}</option>`;
                });

                // FIX: 'overall' je validn√≠ hodnota - nesm√≠me ji p≈ôepsat
                if (currentValue === 'overall') {
                    pieSelect.value = 'overall';
                    pieChartMode = 'overall';
                } else if (currentValue && sortedYears.includes(parseInt(currentValue))) {
                    pieSelect.value = currentValue;
                    pieChartMode = parseInt(currentValue);
                } else if (sortedYears.length > 0) {
                    const currentYear = new Date().getFullYear();
                    if (sortedYears.includes(currentYear)) {
                        pieSelect.value = currentYear;
                        pieChartMode = currentYear;
                    } else {
                        pieSelect.value = sortedYears[0];
                        pieChartMode = sortedYears[0];
                    }
                }
            }

            // FIX: Nemazat canvas innerHTML - zniƒç√≠ canvas element!
            // M√≠sto toho pou≈æ√≠t overlay div pro "≈Ω√°dn√° data"
            const pieWrapper = document.getElementById('pieChart') ? document.getElementById('pieChart').parentNode : null;
            const ctx = document.getElementById('pieChart');
            if (!ctx) return;

            // Filtrov√°n√≠ - FIX: 'overall' zobraz√≠ v≈°echna data
            let exps;
            if (pieChartMode === 'overall') {
                exps = AppState.transactions.filter(t => t.type === 'expense');
            } else if (!isNaN(pieChartMode)) {
                const year = parseInt(pieChartMode);
                exps = AppState.transactions.filter(t => t.type === 'expense' && new Date(t.date).getFullYear() === year);
            } else {
                exps = AppState.transactions.filter(t => t.type === 'expense');
            }

            const totals={}; let sum=0; exps.forEach(t=>{totals[t.category]=(totals[t.category]||0)+t.amount; sum+=t.amount;});
            
            // FIX: Zobrazit "≈Ω√°dn√° data" bez maz√°n√≠ canvasu
            let noDataEl = document.getElementById('pieNoData');
            if (sum === 0) {
                if (expenseChartInstance) { expenseChartInstance.destroy(); expenseChartInstance = null; }
                ctx.style.display = 'none';
                if (!noDataEl) {
                    noDataEl = document.createElement('div');
                    noDataEl.id = 'pieNoData';
                    noDataEl.style.cssText = 'height:100%;display:flex;align-items:center;justify-content:center;color:var(--text-secondary);font-size:0.9rem;';
                    noDataEl.textContent = '≈Ω√°dn√° data';
                    if (pieWrapper) pieWrapper.appendChild(noDataEl);
                }
                return;
            }
            // Skr√Ωt "≈Ω√°dn√° data", zobrazit canvas
            if (noDataEl) noDataEl.style.display = 'none';
            ctx.style.display = '';

            if(expenseChartInstance)expenseChartInstance.destroy(); 
            
            // Se≈ôad√≠me data od nejvy≈°≈°√≠ho po nejni≈æ≈°√≠
            const sortedEntries = Object.entries(totals).sort((a, b) => b[1] - a[1]);
            const dataLabels = sortedEntries.map(e => e[0]);
            const dataValues = sortedEntries.map(e => e[1]);
            
            // Pou≈æit√≠ barev z nastaven√≠
            const backgroundColors = dataLabels.map(cat => AppState.categoryColors[cat] || '#cccccc');

            expenseChartInstance=new Chart(ctx,{
                type:'doughnut',
                data:{
                    labels: dataLabels,
                    datasets:[{
                        data: dataValues, 
                        backgroundColor: backgroundColors, 
                        borderWidth: 3,
                        borderColor: '#121212',
                        hoverOffset: 15,
                        hoverBorderWidth: 4,
                        hoverBorderColor: '#ffffff'
                    }]
                },
                options:{
                    responsive:true,
                    maintainAspectRatio:false,
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000,
                        easing: 'easeOutQuart'
                    },
                    plugins:{
                        legend:{
                            position:'bottom', 
                            labels:{
                                usePointStyle:true,
                                font:{family:'Inter',size:11, weight: '600'},
                                color:'#ffffff',
                                boxWidth:12,
                                boxHeight: 12,
                                padding: 16,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percentage = ((value / total) * 100).toFixed(1) + '%';
                                            const amount = formatMoney(value);
                                            return {
                                                text: `${label} (${percentage})`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: chart.getDatasetMeta(0).data[i].hidden,
                                                index: i,
                                                fontColor: '#ffffff',
                                                pointStyle: 'circle'
                                            };
                                        });
                                    }
                                    return [];
                                }
                            },
                            onClick: function(e, legendItem, legend) {
                                const index = legendItem.index;
                                const chart = legend.chart;
                                const meta = chart.getDatasetMeta(0);
                                meta.data[index].hidden = !meta.data[index].hidden;
                                chart.update();
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(18, 18, 18, 0.95)',
                            titleColor: '#fff',
                            titleFont: {family:'Inter', size: 13, weight: 'bold'},
                            bodyColor: '#a0a0a0',
                            bodyFont: {family:'Inter', size: 12},
                            borderColor: '#333',
                            borderWidth: 1,
                            padding: 14,
                            displayColors: true,
                            boxPadding: 6,
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    let value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return ` ${label}: ${formatMoney(value)} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout:'68%'
                }
            }); 
        }

        function updateBalanceChart(mode, btn, year = null) {
            // Napln√≠me select s roky
            const yearSelect = document.getElementById('balanceYearSelect');
            if (yearSelect) {
                const years = new Set();
                AppState.transactions.forEach(t => {
                    const y = new Date(t.date).getFullYear();
                    years.add(y);
                });
                
                const sortedYears = Array.from(years).sort((a, b) => b - a);
                const currentValue = yearSelect.value;
                
                yearSelect.innerHTML = '<option value="current">Aktu√°ln√≠ obdob√≠</option>';
                sortedYears.forEach(y => {
                    yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
                });
                
                // Pokud je zad√°n rok, pou≈æijeme ho
                if (year !== null) {
                    yearSelect.value = year;
                } else if (currentValue && (currentValue === 'current' || sortedYears.includes(parseInt(currentValue)))) {
                    yearSelect.value = currentValue;
                }
                
                // Pokud nen√≠ zad√°n rok, pou≈æijeme hodnotu ze selectu
                if (year === null) {
                    const selectedYear = yearSelect.value;
                    if (selectedYear !== 'current' && !isNaN(selectedYear)) {
                        year = parseInt(selectedYear);
                    }
                }
            }
            
            if(btn) { document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); } 
            const ctx = document.getElementById('balanceChart').getContext('2d'); 
            const labels = []; const data = [];
            
            // Pokud je zad√°n konkr√©tn√≠ rok, zobraz√≠me data pro tento rok
            if (year !== null && year > 2000) {
                for (let m = 0; m < 12; m++) { 
                    labels.push(`${m+1}/${year.toString().substr(-2)}`); 
                    let b = 0; 
                    AppState.transactions.forEach(t => { 
                        const td = new Date(t.date); 
                        if(td.getMonth() === m && td.getFullYear() === year) 
                            b += (t.type === 'income' ? t.amount : -t.amount); 
                    }); 
                    data.push(b); 
                }
            } else if (mode > 2000) { 
                for (let m = 0; m < 12; m++) { labels.push(`${m+1}/${mode.toString().substr(-2)}`); let b = 0; AppState.transactions.forEach(t => { const td = new Date(t.date); if(td.getMonth() === m && td.getFullYear() === mode) b += (t.type === 'income' ? t.amount : -t.amount); }); data.push(b); } 
            } else { 
                for (let i = mode - 1; i >= 0; i--) { const d = new Date(); d.setMonth(d.getMonth() - i); labels.push(`${d.getMonth()+1}/${d.getFullYear().toString().substr(-2)}`); let b = 0; AppState.transactions.forEach(t => { const td = new Date(t.date); if(td.getMonth() === d.getMonth() && td.getFullYear() === d.getFullYear()) b += (t.type === 'income' ? t.amount : -t.amount); }); data.push(b); } 
            } 
            if(balanceChartInstance) balanceChartInstance.destroy(); 
            balanceChartInstance = new Chart(ctx, { 
                type: 'bar', 
                data: { labels, datasets: [{ data, backgroundColor: function(context) {
                    const value = context.parsed.y;
                    const chart = context.chart;
                    const {ctx, chartArea} = chart;
                    if (!chartArea) return value < 0 ? '#ef4444' : '#22c55e';
                    const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                    if (value < 0) {
                        gradient.addColorStop(0, 'rgba(239, 68, 68, 0.6)');
                        gradient.addColorStop(1, 'rgba(239, 68, 68, 1)');
                    } else {
                        gradient.addColorStop(0, 'rgba(34, 197, 94, 0.6)');
                        gradient.addColorStop(1, 'rgba(34, 197, 94, 1)');
                    }
                    return gradient;
                }, borderRadius: 6, borderSkipped: false }]}, 
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    scales: { 
                        y: { 
                            grace: '10%',
                            grid: { color: 'rgba(51, 51, 51, 0.5)', drawBorder: false }, 
                            ticks: { color: '#a0a0a0', font:{family:'Inter',size:10} } 
                        }, 
                        x: { grid: { display: false }, ticks: { color: '#a0a0a0', font:{family:'Inter',size:9} } } 
                    }, 
                    plugins: { legend: { display: false }, tooltip: { 
                        backgroundColor: 'rgba(18, 18, 18, 0.95)',
                        titleColor: '#fff',
                        bodyColor: '#a0a0a0',
                        borderColor: '#333',
                        borderWidth: 1,
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return formatMoney(context.parsed.y);
                            }
                        }
                    } } 
                } 
            }); 
        }

        function updateIncomeExpenseChart() {
            const selectElement = document.getElementById('incomeExpenseYearSelect');
            const selectedValue = selectElement.value;
            
            if (selectedValue === 'all') {
                // Pro "v≈°echny roky" zobraz√≠me posledn√≠ rok
                const years = [...new Set(AppState.transactions.map(t => new Date(t.date).getFullYear()))].sort((a,b) => b - a);
                if (years.length > 0) {
                    renderIncomeExpenseLineChart(years[0]);
                }
            } else {
                renderIncomeExpenseLineChart(parseInt(selectedValue));
            }
        }

        function renderIncomeExpenseLineChart(selectedYear = null) {
            const selectElement = document.getElementById('incomeExpenseYearSelect');
            if (!selectElement) return;
            
            const years = [...new Set(AppState.transactions.map(t => new Date(t.date).getFullYear()))].sort((a,b) => b - a);
            
            // Inicializace selectu p≈ôi prvn√≠m vol√°n√≠
            if (selectElement.options.length <= 1) {
                selectElement.innerHTML = '';
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    selectElement.appendChild(option);
                });
                
                // Nastav√≠me aktu√°ln√≠ rok jako v√Ωchoz√≠
                const currentYear = new Date().getFullYear();
                if (years.includes(currentYear)) {
                    selectElement.value = currentYear;
                    selectedYear = currentYear;
                } else if (years.length > 0) {
                    selectElement.value = years[0];
                    selectedYear = years[0];
                }
            }
            
            // Pokud nen√≠ zad√°n rok, vezmeme ho z selectu
            if (!selectedYear) {
                selectedYear = parseInt(selectElement.value);
            }


            const monthlyData = {};
            for (let m = 0; m < 12; m++) {
                monthlyData[m] = { income: 0, expense: 0 };
            }

            AppState.transactions.forEach(t => {
                const date = new Date(t.date);
                if (date.getFullYear() === selectedYear) {
                    const month = date.getMonth();
                    if (t.type === 'income') {
                        monthlyData[month].income += t.amount;
                    } else {
                        monthlyData[month].expense += t.amount;
                    }
                }
            });

            const labels = ['Leden', '√önor', 'B≈ôezen', 'Duben', 'Kvƒõten', 'ƒåerven', 'ƒåervenec', 'Srpen', 'Z√°≈ô√≠', '≈ò√≠jen', 'Listopad', 'Prosinec'];
            const incomeData = Object.values(monthlyData).map(d => d.income);
            const expenseData = Object.values(monthlyData).map(d => d.expense);

            const ctx = document.getElementById('incomeExpenseLineChart').getContext('2d');
            if (incomeExpenseLineChartInstance) incomeExpenseLineChartInstance.destroy();
            
            incomeExpenseLineChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'P≈ô√≠jmy',
                            data: incomeData,
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#22c55e',
                            pointBorderColor: '#000',
                            pointBorderWidth: 2
                        },
                        {
                            label: 'V√Ωdaje',
                            data: expenseData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#ef4444',
                            pointBorderColor: '#000',
                            pointBorderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(51, 51, 51, 0.5)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#a0a0a0',
                                font: { family: 'Inter', size: 10 },
                                callback: function(value) {
                                    return value / 1000 + 'k';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#a0a0a0',
                                font: { family: 'Inter', size: 10 }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#a0a0a0',
                                font: { family: 'Inter', size: 12, weight: 600 },
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(18, 18, 18, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#a0a0a0',
                            borderColor: '#333',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatMoney(context.parsed.y);
                                }
                            }
                        }
                    }
                }
            });
        }

        // ==================================================================================
        // === SEKCE: FINANƒåN√ç PORADNA & N√ÅSTROJE (UPRAVENO: V√≠ce n√°stroj≈Ø) ===
        // ==================================================================================

        function renderAnalysisView() {
            const cont = document.getElementById('strategy-content'); cont.innerHTML = '';
            let totalDebt = AppState.loans.reduce((sum, l) => sum + l.currentPrincipal, 0);
            let monthlyScheduledExpense = AppState.templates.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            let monthlyScheduledIncome = AppState.templates.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            let monthlyDebtPayments = AppState.loans.reduce((sum, l) => sum + l.monthlyPayment, 0);
            let monthlySurplus = monthlyScheduledIncome - monthlyScheduledExpense;
            let currentCash = AppState.balance;
            let dtiRatio = monthlyScheduledIncome > 0 ? (monthlyDebtPayments / monthlyScheduledIncome) * 100 : 0;

            // --- Existuj√≠c√≠ n√°stroje ---

            if (AppState.analysisSettings.showHealth) {
                let healthScore = 50;
                if (monthlySurplus > 0) healthScore += 20; else healthScore -= 25;
                if (totalDebt === 0) healthScore = 100; 
                else { 
                    if (dtiRatio < 20) healthScore += 15; else if (dtiRatio > 45) healthScore -= 20;
                    if (currentCash > (monthlyScheduledExpense * 3)) healthScore += 10; else if (currentCash < 5000) healthScore -= 15;
                }
                healthScore = Math.max(1, Math.min(100, healthScore));
                cont.innerHTML += generateHealthSection(healthScore);
            }

            if (AppState.analysisSettings.showDebt) {
                if (totalDebt > 0) {
                     cont.innerHTML += generateLoanSummaryTable();
                     let yearlyAnnualDefault = Math.max(0, monthlySurplus * 12 * 0.1);
                     cont.innerHTML += setupSimulatorUI(yearlyAnnualDefault);
                     cont.innerHTML += generateStrategyComparatorUI();
                     setTimeout(() => { UI_runSimulatorClick(); }, 100);
                } else {
                     cont.innerHTML += `<div class="card focus" style="border-left: 4px solid var(--accent-green); background: rgba(34, 197, 94, 0.05); margin-top: 24px; padding: 20px; display:flex; align-items:center;"><div style="font-size:2rem; margin-right:16px;">üéâ</div><div><h3 style="color: var(--accent-green); margin-bottom:8px;">Jste bez dluh≈Ø!</h3><p style="font-size:0.9rem; color:var(--text-secondary);">Gratulujeme. Nyn√≠ se zamƒõ≈ôte na vybudov√°n√≠ pln√©ho nouzov√©ho fondu (3-6 mƒõs√≠c≈Ø v√Ωdaj≈Ø, cca ${formatMoney(monthlyScheduledExpense*3)}) a n√°slednƒõ na investice.</p></div></div>`;
                }
            }

            if (AppState.analysisSettings.showCalc) {
                cont.innerHTML += generateQuickCalcUI(monthlyScheduledExpense);
            }

            if (AppState.analysisSettings.showSavings) {
                cont.innerHTML += generateSavingsGoalUI();
            }

            // --- NOV√â N√ÅSTROJE (UPRAVENO) ---

            if (AppState.analysisSettings.showRule503020) {
                cont.innerHTML += generateRule503020UI(monthlyScheduledIncome, monthlyScheduledExpense, monthlyDebtPayments);
            }

            if (AppState.analysisSettings.showNetWorth) {
                cont.innerHTML += generateNetWorthUI(currentCash, totalDebt);
            }

            if (AppState.analysisSettings.showDailyCost) {
                cont.innerHTML += generateDailyCostUI();
            }

            if (AppState.analysisSettings.showSavingsRate) {
                cont.innerHTML += generateSavingsRateUI(monthlyScheduledIncome, monthlyScheduledExpense);
            }

            if (AppState.analysisSettings.showHourlyValue) {
                cont.innerHTML += generateHourlyValueUI(monthlyScheduledIncome);
            }

            if (AppState.analysisSettings.showPayYourselfFirst) {
                cont.innerHTML += generatePayYourselfFirstUI(monthlyScheduledIncome);
            }

            if (AppState.analysisSettings.showSubAudit) {
                cont.innerHTML += generateSubAuditUI();
            }

            // --- NOV√â POKROƒåIL√â N√ÅSTROJE ---

            if (AppState.analysisSettings.showExpenseTrends) {
                cont.innerHTML += generateExpenseTrendsUI();
            }

            if (AppState.analysisSettings.showFIRE) {
                cont.innerHTML += generateFIREUI(monthlyScheduledIncome, monthlyScheduledExpense);
            }

            if (AppState.analysisSettings.showInflation) {
                cont.innerHTML += generateInflationUI();
            }

            if (AppState.analysisSettings.showLeakDetector) {
                cont.innerHTML += generateLeakDetectorUI();
            }

            if (AppState.analysisSettings.showFixedVsVariable) {
                cont.innerHTML += generateFixedVsVariableUI();
            }

            if (AppState.analysisSettings.showScenario) {
                cont.innerHTML += generateScenarioUI(monthlyScheduledExpense, currentCash);
            }

            if (AppState.analysisSettings.showForecast) {
                cont.innerHTML += generateForecastUI(monthlyScheduledIncome, monthlyScheduledExpense);
            }
        }

        // --- P≈Øvodn√≠ pomocn√© funkce pro anal√Ωzu ---

        function generateHealthSection(score) {
            let status, color, rotation;
            if (score >= 85) { status = "Excelentn√≠"; color = "var(--accent-green)"; rotation = "135deg"; }
            else if (score >= 60) { status = "Stabiln√≠"; color = "var(--accent-blue)"; rotation = "45deg"; }
            else if (score >= 35) { status = "Rizikov√Ω"; color = "var(--warn)"; rotation = "-45deg"; }
            else { status = "Kritick√Ω"; color = "var(--accent-red)"; rotation = "-135deg"; }
            return `<div class="health-index-container"><div class="health-status-label" style="background: ${color}; color: var(--bg-card);">${status} stav</div><div class="health-gauge"><div class="health-gauge-arc"></div><div class="health-gauge-fill" style="border-top-color: ${color}; transform: rotate(${rotation});"></div></div><div class="health-score-big" style="color: ${color};">${score}</div><div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">Index finanƒçn√≠ho zdrav√≠ (0-100)</div></div>`;
        }
        function generateLoanSummaryTable() {
            let loans = AppState.loans.filter(l => l.currentPrincipal > 1).sort((a, b) => b.interestRate - a.interestRate);
            if (loans.length === 0) return '';
            let html = `<div class="card" style="padding: 16px;"><h3>P≈ôehled z√°vazk≈Ø (dle √∫roku)</h3><table class="loan-summary-table"><thead><tr><th>N√°zev</th><th style="text-align:right;">Z≈Østatek</th><th style="text-align:right;">√örok p.a.</th><th style="text-align:right;">Min. spl√°tka</th></tr></thead><tbody>`;
            loans.forEach(l => { const isHighRate = l.interestRate >= 10; html += `<tr><td>${l.name}</td><td style="text-align:right; font-weight:600;">${formatMoney(l.currentPrincipal)}</td><td style="text-align:right;"><span class="rate-badge ${isHighRate ? 'high' : ''}">${l.interestRate.toFixed(1)}%</span></td><td style="text-align:right;">${formatMoney(l.monthlyPayment)}</td></tr>`; });
            html += `</tbody></table></div>`; return html;
        }
        function setupSimulatorUI(defaultAnnualValue) {
            let initialSimValue = Math.max(0, Math.round(defaultAnnualValue / 1000) * 1000);
            return `<div class="card" style="margin-top: 24px; border-color: var(--accent-purple);"><h3 style="color: var(--accent-purple);">Simul√°tor oddlu≈æen√≠ (Roƒçn√≠ bonus)</h3><p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom: 12px;">Zadejte ƒç√°stku, kterou m≈Ø≈æete vlo≈æit <b>jednou roƒçnƒõ</b> nav√≠c (nap≈ô. z roƒçn√≠ho bonusu). Syst√©m ji pou≈æije na nejdra≈æ≈°√≠ dluh (metoda Lavina).</p><div class="sim-input-group"><label class="sim-input-label">Roƒçn√≠ mimo≈ô√°dn√° spl√°tka (1x)</label><input type="number" id="simExtraPayment" class="sim-input" value="${initialSimValue}" min="0" step="1000" onchange="UI_runSimulatorClick()"></div><button class="sim-btn" onclick="UI_runSimulatorClick()">P≈ôepoƒç√≠tat pl√°n a grafy</button></div><div id="simResultsArea" style="display:none;"><h3 style="margin-top: 30px; margin-bottom: 16px;">V√°≈° osobn√≠ pl√°n oddlu≈æen√≠ (P≈ô√≠≈°t√≠ch 12 mƒõs√≠c≈Ø)</h3><div id="simTimelineContainer" class="timeline-container"></div><div class="card" style="margin-top: 30px;"><h3>Mƒõs√≠ƒçn√≠ predikce v√Ωvoje dluhu (2 roky)</h3><div class="chart-container" style="height: 250px;"><canvas id="simMonthlyChart"></canvas></div><h3 style="margin-top: 20px;">Dlouhodob√Ω roƒçn√≠ v√Ωhled</h3><div class="chart-container" style="height: 250px;"><canvas id="simYearlyChart"></canvas></div></div></div>`;
        }
        function generateStrategyComparatorUI() {
            return `<div class="card" style="margin-top: 24px; border: 1px solid var(--accent-blue);"><h3 style="color: var(--accent-blue);">Porovn√°n√≠ strategi√≠ spl√°cen√≠</h3><p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom: 12px;">Pod√≠vejte se, jak√Ω vliv m√° volba strategie na celkovou dobu spl√°cen√≠ a zaplacen√© √∫roky, p≈ôi pou≈æit√≠ v√Ω≈°e zadan√© roƒçn√≠ mimo≈ô√°dn√© spl√°tky.</p><button class="btn btn-primary btn-block" onclick="UI_runComparatorClick()" style="background: var(--accent-blue); color: white; border: none;">Spustit porovn√°n√≠ (Lavina vs. Snƒõhov√° koule)</button><div id="comparatorResultsArea" style="display:none; margin-top: 20px;"></div></div>`;
        }
        function generateQuickCalcUI(monthlyExpenses) {
            return `<div class="card" style="margin-top: 30px; border: 1px solid var(--text-muted);"><h3>Rychl√° kalkulaƒçka: Rezerva a C√≠le</h3><p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom: 12px;">Spoƒç√≠tejte si doporuƒçenou v√Ω≈°i finanƒçn√≠ rezervy na z√°kladƒõ va≈°ich mƒõs√≠ƒçn√≠ch v√Ωdaj≈Ø (dle ≈°ablon).</p><div class="form-group"><label class="form-label">Va≈°e mƒõs√≠ƒçn√≠ trval√© v√Ωdaje</label><input type="number" id="qcMonthlyExpenses" class="form-input" value="${monthlyExpenses}" inputmode="decimal"></div><div class="quick-calc-grid"><button class="qc-btn" onclick="calculateReserveTarget(3)">3x (Minimum)</button><button class="qc-btn" onclick="calculateReserveTarget(6)">6x (Doporuƒçeno)</button><button class="qc-btn" onclick="calculateReserveTarget(12)">12x (Jistota)</button></div><div id="qcResultArea" class="qc-result" style="display:none;"><div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">C√≠lov√° ƒç√°stka rezervy:</div><div id="qcResultValue" style="font-size: 1.5rem; font-weight: 900; color: var(--text-primary);">0 Kƒç</div></div></div>`;
        }
        function calculateReserveTarget(multiplier) {
            const expenses = parseFloat(document.getElementById('qcMonthlyExpenses').value) || 0;
            const target = expenses * multiplier;
            document.getElementById('qcResultValue').textContent = formatMoney(target);
            document.getElementById('qcResultArea').style.display = 'block';
        }
        function generateSavingsGoalUI() {
            return `<div class="card" style="margin-top: 30px; border: 1px solid var(--accent-green);"><h3 style="color: var(--accent-green);">Kalkulaƒçka spo≈ô√≠c√≠ho c√≠le</h3><p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom: 12px;">Zjistƒõte, za jak dlouho dos√°hnete sv√©ho finanƒçn√≠ho c√≠le p≈ôi souƒçasn√©m tempu spo≈ôen√≠.</p><div class="form-grid two-col"><div class="form-group"><label class="form-label">C√≠lov√° ƒç√°stka</label><input type="number" id="sgTargetAmount" class="form-input" placeholder="Nap≈ô. 50000" inputmode="decimal"></div><div class="form-group"><label class="form-label">Mƒõs√≠ƒçn√≠ √∫lo≈æka</label><input type="number" id="sgMonthlySaving" class="form-input" placeholder="Nap≈ô. 2000" inputmode="decimal"></div><div class="form-group"><label class="form-label">Ji≈æ naspo≈ôeno</label><input type="number" id="sgCurrentSavings" class="form-input" placeholder="Nap≈ô. 5000" inputmode="decimal" value="0"></div></div><button class="btn btn-primary btn-block" style="margin-top: 12px; background: var(--accent-green);" onclick="calculateSavingsGoal()">Vypoƒç√≠tat dobu spo≈ôen√≠</button><div id="sgResultArea" class="qc-result" style="display:none; border-color: var(--accent-green);"><div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">C√≠le dos√°hnete za:</div><div id="sgResultValue" style="font-size: 1.5rem; font-weight: 900; color: var(--text-primary);">-</div><div id="sgResultDate" style="font-size: 0.9rem; color: var(--accent-green); font-weight: 600; margin-top: 6px;">-</div></div></div>`;
        }
        function calculateSavingsGoal() {
            const target = parseFloat(document.getElementById('sgTargetAmount').value) || 0;
            const monthly = parseFloat(document.getElementById('sgMonthlySaving').value) || 0;
            const current = parseFloat(document.getElementById('sgCurrentSavings').value) || 0;
            const resultArea = document.getElementById('sgResultArea');
            const resultValue = document.getElementById('sgResultValue');
            const resultDate = document.getElementById('sgResultDate');

            if (target <= 0 || monthly <= 0) {
                alert("Zadejte platnou c√≠lovou ƒç√°stku a mƒõs√≠ƒçn√≠ √∫lo≈æku.");
                return;
            }
            if (current >= target) {
                resultValue.textContent = "C√≠le ji≈æ bylo dosa≈æeno!";
                resultDate.textContent = "Gratulujeme! üéâ";
                resultArea.style.display = 'block';
                return;
            }

            const remaining = target - current;
            const months = Math.ceil(remaining / monthly);
            
            let timeStr = "";
            if (months < 12) {
                timeStr = `${months} mƒõs√≠c≈Ø`;
            } else {
                const years = Math.floor(months / 12);
                const remainingMonths = months % 12;
                timeStr = `${years} let` + (remainingMonths > 0 ? ` a ${remainingMonths} mƒõs√≠c≈Ø` : "");
            }

            const futureDate = new Date();
            futureDate.setMonth(futureDate.getMonth() + months);
            const dateStr = futureDate.toLocaleDateString('cs-CZ', { month: 'long', year: 'numeric' });

            resultValue.textContent = timeStr;
            resultDate.textContent = `(P≈ôibli≈ænƒõ v ${dateStr})`;
            resultArea.style.display = 'block';
        }

        // --- NOV√â POMOCN√â FUNKCE PRO ANAL√ùZU (UPRAVENO) ---

        function generateRule503020UI(income, expenses, debt) {
            if (income === 0) return '';
            const needs = (expenses + debt) / income * 100;
            const savings = Math.max(0, (income - expenses - debt)) / income * 100;
            const wants = 100 - needs - savings;
            return `<div class="card" style="margin-top: 30px; border: 1px solid var(--accent-cyan);"><h3 style="color: var(--accent-cyan);">Pravidlo 50/30/20 (Snapshot)</h3><p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom: 12px;">Rychl√Ω pohled na va≈°e finance podle trval√Ωch p≈ô√≠jm≈Ø a v√Ωdaj≈Ø (Nutnosti / Chtƒõn√≠ / √öspory).</p><div style="display: flex; height: 24px; border-radius: 12px; overflow: hidden; margin-bottom: 8px;"><div style="width: ${needs}%; background: var(--accent-red);"></div><div style="width: ${wants}%; background: var(--warn);"></div><div style="width: ${savings}%; background: var(--accent-green);"></div></div><div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-secondary);"><span>Nutnosti: ${needs.toFixed(0)}% (C√≠l: 50%)</span><span>Chtƒõn√≠: ${wants.toFixed(0)}% (C√≠l: 30%)</span><span>√öspory: ${savings.toFixed(0)}% (C√≠l: 20%)</span></div></div>`;
        }

        function generateNetWorthUI(cash, debt) {
            const netWorth = cash - debt;
            const color = netWorth >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            return `<div class="card" style="margin-top: 30px; border: 1px solid var(--accent-cyan);"><h3 style="color: var(--accent-cyan);">Odhad ƒçist√©ho jmƒõn√≠</h3><p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom: 12px;">Rozd√≠l mezi va≈°imi aktivy (z≈Østatek) a pasivy (dluhy).</p><div style="text-align: center; padding: 16px;"><div style="font-size: 0.9rem; color: var(--text-secondary);">Va≈°e ƒçist√© jmƒõn√≠:</div><div style="font-size: 2rem; font-weight: 900; color: ${color};">${formatMoney(netWorth)}</div><div style="display: flex; justify-content: center; gap: 20px; margin-top: 12px; font-size: 0.85rem;"><div class="text-success">Aktiva: ${formatMoney(cash)}</div><div class="text-danger">Pasiva: ${formatMoney(debt)}</div></div></div></div>`;
        }

        function generateDailyCostUI() {
            return `<div class="card" style="margin-top: 30px; border: 1px solid var(--accent-cyan);"><h3 style="color: var(--accent-cyan);">Kalkulaƒçka denn√≠ch n√°vyk≈Ø</h3><p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom: 12px;">Kolik v√°s stoj√≠ drobn√© denn√≠ v√Ωdaje (k√°va, svaƒçina) za rok?</p><div class="form-group"><label class="form-label">Cena denn√≠ho n√°vyku (Kƒç)</label><input type="number" id="dcDailyCost" class="form-input" placeholder="Nap≈ô. 60" inputmode="decimal" oninput="calculateDailyCost()"></div><div id="dcResultArea" style="display:none; margin-top: 16px; text-align: center;"><div style="font-size: 0.9rem; color: var(--text-secondary);">Za rok utrat√≠te:</div><div id="dcResultValue" style="font-size: 1.8rem; font-weight: 900; color: var(--accent-cyan);">0 Kƒç</div></div></div>`;
        }
        function calculateDailyCost() {
            const cost = parseFloat(document.getElementById('dcDailyCost').value) || 0;
            const yearly = cost * 365;
            document.getElementById('dcResultValue').textContent = formatMoney(yearly);
            document.getElementById('dcResultArea').style.display = yearly > 0 ? 'block' : 'none';
        }

        function generateSavingsRateUI(income, expenses) {
            if (income === 0) return '';
            const savings = Math.max(0, income - expenses);
            const rate = (savings / income * 100).toFixed(1);
            let comment = ""; if (rate >= 20) comment = "Skvƒõl√©! üåü"; else if (rate >= 10) comment = "Dobr√° pr√°ce. üëç"; else comment = "Zkuste zv√Ω≈°it. üí™";
            return `<div class="card" style="margin-top: 30px; border: 1px solid var(--accent-orange);"><h3 style="color: var(--accent-orange);">Odhad m√≠ry √∫spor</h3><p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom: 12px;">Kolik procent z va≈°ich trval√Ωch p≈ô√≠jm≈Ø v√°m zb√Ωv√° po zaplacen√≠ trval√Ωch v√Ωdaj≈Ø.</p><div style="text-align: center; padding: 16px;"><div style="font-size: 3rem; font-weight: 900; color: var(--accent-orange);">${rate}%</div><div style="font-weight: 600; margin-top: 8px;">${comment}</div><div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">(Z p≈ô√≠jmu ${formatMoney(income)} zb√Ωv√° ${formatMoney(savings)})</div></div></div>`;
        }

        function generateHourlyValueUI(monthlyIncome) {
            return `<div class="card" style="margin-top: 30px; border: 1px solid var(--accent-orange);"><h3 style="color: var(--accent-orange);">Hodinov√° hodnota ƒçasu</h3><p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom: 12px;">Spoƒç√≠tejte si p≈ôibli≈ænou hodnotu va≈°√≠ hodiny pr√°ce pro lep≈°√≠ rozhodov√°n√≠ o v√Ωdaj√≠ch.</p><div class="form-group"><label class="form-label">Mƒõs√≠ƒçn√≠ ƒçist√Ω p≈ô√≠jem (Kƒç)</label><input type="number" id="hvIncome" class="form-input" value="${monthlyIncome > 0 ? monthlyIncome : ''}" placeholder="Nap≈ô. 35000" inputmode="decimal"></div><div class="form-group"><label class="form-label">Odpracovan√© hodiny mƒõs√≠ƒçnƒõ</label><input type="number" id="hvHours" class="form-input" value="160" placeholder="Nap≈ô. 160" inputmode="decimal"></div><button class="btn btn-primary btn-block" style="margin-top: 12px; background: var(--accent-orange);" onclick="calculateHourlyValue()">Vypoƒç√≠tat</button><div id="hvResultArea" class="qc-result" style="display:none; border-color: var(--accent-orange);"><div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">Va≈°e hodina m√° hodnotu cca:</div><div id="hvResultValue" style="font-size: 1.5rem; font-weight: 900; color: var(--text-primary);">0 Kƒç</div></div></div>`;
        }
        function calculateHourlyValue() {
            const income = parseFloat(document.getElementById('hvIncome').value) || 0;
            const hours = parseFloat(document.getElementById('hvHours').value) || 0;
            if (income <= 0 || hours <= 0) { alert("Zadejte platn√Ω p≈ô√≠jem a poƒçet hodin."); return; }
            const hourly = income / hours;
            document.getElementById('hvResultValue').textContent = formatMoney(hourly);
            document.getElementById('hvResultArea').style.display = 'block';
        }

        function generatePayYourselfFirstUI(monthlyIncome) {
            return `<div class="card" style="margin-top: 30px; border: 1px solid var(--accent-orange);"><h3 style="color: var(--accent-orange);">Kontrola "Zapla≈• si prvn√≠"</h3><p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom: 12px;">Princip: Po≈°li si pen√≠ze na spo≈ôen√≠/investice hned po v√Ωplatƒõ, ne a≈æ z toho, co zbyde.</p><div class="form-group"><label class="form-label">Mƒõs√≠ƒçn√≠ ƒçist√Ω p≈ô√≠jem (Kƒç)</label><input type="number" id="pyfIncome" class="form-input" value="${monthlyIncome > 0 ? monthlyIncome : ''}" placeholder="Nap≈ô. 35000" inputmode="decimal" oninput="calculatePYF()"></div><div class="form-group"><label class="form-label">C√≠lov√© procento √∫spor (%)</label><input type="range" id="pyfSlider" class="form-input" min="5" max="30" value="15" step="5" oninput="calculatePYF()" style="padding: 0;"><div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-secondary); padding: 0 4px;"><span>5%</span><span id="pyfSliderValue" style="font-weight: 700; color: var(--accent-orange);">15%</span><span>30%</span></div></div><div id="pyfResultArea" class="qc-result" style="display:none; border-color: var(--accent-orange);"><div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">Hned po v√Ωplatƒõ si po≈°lete:</div><div id="pyfResultValue" style="font-size: 1.5rem; font-weight: 900; color: var(--text-primary);">0 Kƒç</div></div></div>`;
        }
        function calculatePYF() {
            const income = parseFloat(document.getElementById('pyfIncome').value) || 0;
            const percent = parseInt(document.getElementById('pyfSlider').value);
            document.getElementById('pyfSliderValue').textContent = percent + '%';
            if (income > 0) {
                const amount = income * (percent / 100);
                document.getElementById('pyfResultValue').textContent = formatMoney(amount);
                document.getElementById('pyfResultArea').style.display = 'block';
            } else {
                document.getElementById('pyfResultArea').style.display = 'none';
            }
        }

        function generateSubAuditUI() {
            let subTemplates = AppState.templates.filter(t => t.type === 'expense' && ['Spotify','Netflix','HBO','Disney+','Apple','Google','P≈ôedplatn√©','ƒålenstv√≠'].some(k => t.desc.toLowerCase().includes(k.toLowerCase())));
            let totalSubCost = subTemplates.reduce((sum, t) => sum + t.amount, 0);
            let html = `<div class="card" style="margin-top: 30px; border: 1px solid var(--accent-orange);"><h3 style="color: var(--accent-orange);">Audit p≈ôedplatn√Ωch (≈†ablony)</h3><p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom: 12px;">Rychl√Ω p≈ôehled nalezen√Ωch p≈ôedplatn√Ωch ve va≈°ich ≈°ablon√°ch trval√Ωch plateb.</p>`;
            if (subTemplates.length > 0) {
                html += `<ul style="padding-left: 20px; margin-bottom: 16px; color: var(--text-secondary);">`;
                subTemplates.forEach(t => { html += `<li style="margin-bottom: 4px;"><b>${t.desc}</b>: ${formatMoney(t.amount)}</li>`; });
                html += `</ul><div style="text-align: center; padding: 12px; background: var(--bg-subtle); border-radius: 12px;"><div style="font-size: 0.9rem; color: var(--text-secondary);">Celkem mƒõs√≠ƒçnƒõ:</div><div style="font-size: 1.4rem; font-weight: 900; color: var(--accent-red);">${formatMoney(totalSubCost)}</div><div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">(Roƒçnƒõ: ${formatMoney(totalSubCost * 12)})</div></div><p style="font-size:0.8rem; color:var(--text-secondary); margin-top: 12px; text-align: center;">Tip: Opravdu vyu≈æ√≠v√°te v≈°echny tyto slu≈æby naplno?</p>`;
            } else {
                html += `<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Nenalezena ≈æ√°dn√° zjevn√° p≈ôedplatn√° v ≈°ablon√°ch.</p>`;
            }
            html += `</div>`;
            return html;
        }

        // --- NOV√â POKROƒåIL√â FUNKCE ---

        // 2. Anal√Ωza v√Ωdajov√Ωch trend≈Ø
        function generateExpenseTrendsUI() {
            const now = new Date();
            const periods = [3, 6, 12];
            let html = `<div class="card" style="margin-top: 30px; border: 1px solid var(--accent-purple);">
                <h3 style="color: var(--accent-purple);">üìä Anal√Ωza v√Ωdajov√Ωch trend≈Ø</h3>
                <p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom: 16px;">Porovn√°n√≠ v√Ωdaj≈Ø v kategori√≠ch za posledn√≠ mƒõs√≠ce.</p>`;
            
            const categoryTrends = {};
            AppState.categories.expense.forEach(cat => {
                categoryTrends[cat] = { last3: 0, last6: 0, last12: 0 };
            });

            AppState.transactions.filter(t => t.type === 'expense').forEach(t => {
                const txDate = new Date(t.date);
                const monthsAgo = Math.floor((now - txDate) / (1000 * 60 * 60 * 24 * 30));
                
                if (monthsAgo <= 3) categoryTrends[t.category].last3 += t.amount;
                if (monthsAgo <= 6) categoryTrends[t.category].last6 += t.amount;
                if (monthsAgo <= 12) categoryTrends[t.category].last12 += t.amount;
            });

            const sortedCategories = Object.entries(categoryTrends)
                .filter(([cat, data]) => data.last12 > 0)
                .sort((a, b) => b[1].last12 - a[1].last12)
                .slice(0, 5);

            if (sortedCategories.length > 0) {
                html += `<div style="margin-top: 12px;">`;
                sortedCategories.forEach(([cat, data]) => {
                    const avg3 = data.last3 / 3;
                    const avg6 = data.last6 / 6;
                    const avg12 = data.last12 / 12;
                    
                    let trend = '';
                    let trendColor = 'var(--text-secondary)';
                    if (avg3 > avg12 * 1.2) { trend = 'üìà Roste (+20%)'; trendColor = 'var(--accent-red)'; }
                    else if (avg3 < avg12 * 0.8) { trend = 'üìâ Kles√° (-20%)'; trendColor = 'var(--accent-green)'; }
                    else { trend = '‚û°Ô∏è Stabiln√≠'; trendColor = 'var(--text-secondary)'; }

                    html += `<div style="margin-bottom: 16px; padding: 12px; background: var(--bg-subtle); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 700;">${cat}</span>
                            <span style="color: ${trendColor}; font-weight: 600;">${trend}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-secondary);">
                            <span>3M: ${formatMoney(avg3)}/mƒõs</span>
                            <span>6M: ${formatMoney(avg6)}/mƒõs</span>
                            <span>12M: ${formatMoney(avg12)}/mƒõs</span>
                        </div>
                    </div>`;
                });
                html += `</div>`;
            } else {
                html += `<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Nedostatek dat pro anal√Ωzu trend≈Ø.</p>`;
            }
            
            html += `</div>`;
            return html;
        }

        // 3. FIRE kalkulaƒçka
        function generateFIREUI(income, expenses) {
            if (income === 0 || expenses === 0) return '';
            const savings = Math.max(0, income - expenses);
            return `<div class="card" style="margin-top: 30px; border: 1px solid var(--accent-purple);">
                <h3 style="color: var(--accent-purple);">üî• FIRE kalkulaƒçka</h3>
                <p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom: 12px;">Financial Independence, Retire Early - kolik let do finanƒçn√≠ nez√°vislosti?</p>
                
                <div class="form-group">
                    <label class="form-label">Po≈æadovan√Ω mƒõs√≠ƒçn√≠ pasivn√≠ p≈ô√≠jem (Kƒç)</label>
                    <input type="number" id="fireDesiredIncome" class="form-input" value="${expenses}" placeholder="Nap≈ô. ${expenses}" inputmode="decimal">
                </div>
                
                <div class="form-group">
                    <label class="form-label">P≈ôedpokl√°dan√Ω roƒçn√≠ v√Ωnos investic (%)</label>
                    <input type="number" id="fireReturn" class="form-input" value="4" step="0.5" inputmode="decimal">
                    <p style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 4px;">Konzervativn√≠: 3-4%, Optimistick√Ω: 6-8%</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Aktu√°ln√≠ √∫spory/investice (Kƒç)</label>
                    <input type="number" id="fireCurrentSavings" class="form-input" value="0" inputmode="decimal">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Mƒõs√≠ƒçn√≠ √∫spory (Kƒç)</label>
                    <input type="number" id="fireMonthlySavings" class="form-input" value="${savings}" placeholder="${savings}" inputmode="decimal">
                </div>
                
                <button class="btn btn-primary btn-block" style="margin-top: 12px; background: var(--accent-purple);" onclick="calculateFIRE()">Vypoƒç√≠tat FIRE</button>
                
                <div id="fireResultArea" style="display:none; margin-top: 20px; padding: 16px; background: var(--bg-subtle); border-radius: 12px; border: 1px solid var(--accent-purple);">
                    <div style="text-align: center;">
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Pot≈ôebn√° ƒç√°stka (25x roƒçn√≠ v√Ωdaje):</div>
                        <div id="fireNeededAmount" style="font-size: 1.6rem; font-weight: 900; color: var(--accent-purple); margin: 8px 0;">0 Kƒç</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 16px;">ƒåas do dosa≈æen√≠ c√≠le:</div>
                        <div id="fireYearsToFI" style="font-size: 2.2rem; font-weight: 900; color: var(--accent-green); margin: 8px 0;">0 let</div>
                        <div id="fireDateEstimate" style="font-size: 0.8rem; color: var(--text-secondary);"></div>
                    </div>
                </div>
            </div>`;
        }

        function calculateFIRE() {
            const desiredIncome = parseFloat(document.getElementById('fireDesiredIncome').value) || 0;
            const returnRate = parseFloat(document.getElementById('fireReturn').value) || 4;
            const currentSavings = parseFloat(document.getElementById('fireCurrentSavings').value) || 0;
            const monthlySavings = parseFloat(document.getElementById('fireMonthlySavings').value) || 0;
            
            if (desiredIncome <= 0) { alert("Zadejte po≈æadovan√Ω mƒõs√≠ƒçn√≠ p≈ô√≠jem."); return; }
            
            // 25x pravidlo - pot≈ôebuje≈° 25x roƒçn√≠ch v√Ωdaj≈Ø
            const neededAmount = desiredIncome * 12 * 25;
            document.getElementById('fireNeededAmount').textContent = formatMoney(neededAmount);
            
            const remaining = neededAmount - currentSavings;
            
            if (remaining <= 0) {
                document.getElementById('fireYearsToFI').textContent = "Dosa≈æeno! üéâ";
                document.getElementById('fireDateEstimate').textContent = "Gratulujeme k finanƒçn√≠ nez√°vislosti!";
            } else if (monthlySavings <= 0) {
                document.getElementById('fireYearsToFI').textContent = "‚àû";
                document.getElementById('fireDateEstimate').textContent = "Zaƒçnƒõte spo≈ôit!";
            } else {
                // Zjednodu≈°en√Ω v√Ωpoƒçet bez slo≈æen√©ho √∫roƒçen√≠
                const months = Math.ceil(remaining / monthlySavings);
                const years = Math.floor(months / 12);
                const remainingMonths = months % 12;
                
                const futureDate = new Date();
                futureDate.setMonth(futureDate.getMonth() + months);
                
                let timeStr = years > 0 ? `${years} let` : "";
                if (remainingMonths > 0) timeStr += (timeStr ? " a " : "") + `${remainingMonths} mƒõs√≠c≈Ø`;
                
                document.getElementById('fireYearsToFI').textContent = timeStr;
                document.getElementById('fireDateEstimate').textContent = `P≈ôibli≈ænƒõ v ${futureDate.toLocaleDateString('cs-CZ', { month: 'long', year: 'numeric' })}`;
            }
            
            document.getElementById('fireResultArea').style.display = 'block';
        }

        // 4. Inflaƒçn√≠ dopad
        function generateInflationUI() {
            return `<div class="card" style="margin-top: 30px; border: 1px solid var(--accent-purple);">
                <h3 style="color: var(--accent-purple);">üìà Inflaƒçn√≠ dopad</h3>
                <p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom: 12px;">Jak inflace ovliv≈àuje va≈°i kupn√≠ s√≠lu a kolik pot≈ôebujete vydƒõlat nav√≠c?</p>
                
                <div class="form-group">
                    <label class="form-label">Aktu√°ln√≠ roƒçn√≠ inflace (%)</label>
                    <input type="number" id="inflRate" class="form-input" value="3.5" step="0.1" inputmode="decimal">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Va≈°e souƒçasn√© √∫spory (Kƒç)</label>
                    <input type="number" id="inflSavings" class="form-input" value="${AppState.balance}" inputmode="decimal">
                </div>
                
                <div class="form-group">
                    <label class="form-label">V√°≈° mƒõs√≠ƒçn√≠ p≈ô√≠jem (Kƒç)</label>
                    <input type="number" id="inflIncome" class="form-input" placeholder="Nap≈ô. 35000" inputmode="decimal">
                </div>
                
                <button class="btn btn-primary btn-block" style="margin-top: 12px; background: var(--accent-purple);" onclick="calculateInflation()">Vypoƒç√≠tat dopad</button>
                
                <div id="inflResultArea" style="display:none; margin-top: 20px;">
                    <div style="padding: 16px; background: var(--bg-subtle); border-radius: 12px; border: 1px solid var(--accent-red); margin-bottom: 12px;">
                        <div style="text-align: center;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Ztr√°ta kupn√≠ s√≠ly √∫spor za rok:</div>
                            <div id="inflSavingsLoss" style="font-size: 1.6rem; font-weight: 900; color: var(--accent-red); margin: 8px 0;">0 Kƒç</div>
                        </div>
                    </div>
                    
                    <div style="padding: 16px; background: var(--bg-subtle); border-radius: 12px; border: 1px solid var(--accent-orange);">
                        <div style="text-align: center;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Pot≈ôebn√© zv√Ω≈°en√≠ p≈ô√≠jmu pro vyrovn√°n√≠:</div>
                            <div id="inflIncomeIncrease" style="font-size: 1.6rem; font-weight: 900; color: var(--accent-orange); margin: 8px 0;">0 Kƒç/mƒõs√≠c</div>
                            <div id="inflIncreasePercent" style="font-size: 0.8rem; color: var(--text-secondary);"></div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function calculateInflation() {
            const rate = parseFloat(document.getElementById('inflRate').value) || 0;
            const savings = parseFloat(document.getElementById('inflSavings').value) || 0;
            const income = parseFloat(document.getElementById('inflIncome').value) || 0;
            
            if (rate <= 0) { alert("Zadejte inflaci."); return; }
            
            const savingsLoss = savings * (rate / 100);
            document.getElementById('inflSavingsLoss').textContent = formatMoney(savingsLoss);
            
            if (income > 0) {
                const monthlyIncrease = (income * (rate / 100)) / 12;
                document.getElementById('inflIncomeIncrease').textContent = formatMoney(monthlyIncrease);
                document.getElementById('inflIncreasePercent').textContent = `(+${rate.toFixed(1)}% roƒçnƒõ)`;
            } else {
                document.getElementById('inflIncomeIncrease').textContent = "Zadejte p≈ô√≠jem";
                document.getElementById('inflIncreasePercent').textContent = "";
            }
            
            document.getElementById('inflResultArea').style.display = 'block';
        }

        // 5. Kategorie "leak" detektor
        function generateLeakDetectorUI() {
            const now = new Date();
            const threeMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 3, 1);
            
            const categoryLeaks = {};
            AppState.transactions
                .filter(t => t.type === 'expense' && new Date(t.date) >= threeMonthsAgo)
                .forEach(t => {
                    if (!categoryLeaks[t.category]) {
                        categoryLeaks[t.category] = { total: 0, count: 0, transactions: [] };
                    }
                    categoryLeaks[t.category].total += t.amount;
                    categoryLeaks[t.category].count++;
                    categoryLeaks[t.category].transactions.push(t);
                });

            const leaks = Object.entries(categoryLeaks)
                .filter(([cat, data]) => data.count >= 5) // Minim√°lnƒõ 5 transakc√≠ za 3 mƒõs√≠ce
                .map(([cat, data]) => ({
                    category: cat,
                    total: data.total,
                    count: data.count,
                    avgPerTx: data.total / data.count,
                    yearlyEstimate: (data.total / 3) * 12
                }))
                .sort((a, b) => b.yearlyEstimate - a.yearlyEstimate)
                .slice(0, 5);

            let html = `<div class="card" style="margin-top: 30px; border: 1px solid var(--accent-purple);">
                <h3 style="color: var(--accent-purple);">üîç Kategorie "leak" detektor</h3>
                <p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom: 12px;">Mal√© opakuj√≠c√≠ se v√Ωdaje, kter√© se sƒç√≠taj√≠ do velk√Ωch ƒç√°stek (posledn√≠ 3 mƒõs√≠ce).</p>`;

            if (leaks.length > 0) {
                html += `<div style="margin-top: 12px;">`;
                leaks.forEach((leak, idx) => {
                    html += `<div style="margin-bottom: 16px; padding: 12px; background: var(--bg-subtle); border-radius: 8px; border-left: 3px solid var(--accent-${idx === 0 ? 'red' : idx === 1 ? 'orange' : 'cyan'});">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 700;">${leak.category}</span>
                            <span style="color: var(--accent-red); font-weight: 700;">${leak.count}√ó transakce</span>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">
                            Pr≈Ømƒõr na transakci: ${formatMoney(leak.avgPerTx)}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                            <span style="font-size: 0.8rem; color: var(--text-secondary);">Odhad za rok:</span>
                            <span style="font-size: 1.2rem; font-weight: 900; color: var(--accent-red);">${formatMoney(leak.yearlyEstimate)}</span>
                        </div>
                    </div>`;
                });
                html += `</div>
                <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 16px; text-align: center; font-style: italic;">
                    üí° Tip: Zva≈æte, zda nƒõkter√© z tƒõchto v√Ωdaj≈Ø nejsou zbyteƒçn√© nebo je lze omezit.
                </p>`;
            } else {
                html += `<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Nenalezeny ≈æ√°dn√© v√Ωrazn√© "√∫niky". Skvƒõl√° pr√°ce! üëç</p>`;
            }

            html += `</div>`;
            return html;
        }

        // 6. Pomƒõr fixn√≠ch vs variabiln√≠ch n√°klad≈Ø
        function generateFixedVsVariableUI() {
            const fixedCategories = ['N√°jem', 'Bydlen√≠', 'Poji≈°tƒõn√≠', 'P≈Øjƒçka', 'T-Mobile', 'TV+rozhlas', 'Elekt≈ôina', 'Plyn'];
            
            let fixedTotal = 0;
            let variableTotal = 0;

            AppState.templates.filter(t => t.type === 'expense').forEach(t => {
                const isFixed = fixedCategories.some(fc => t.category.includes(fc) || t.desc.toLowerCase().includes(fc.toLowerCase()));
                if (isFixed) fixedTotal += t.amount;
                else variableTotal += t.amount;
            });

            const total = fixedTotal + variableTotal;
            const fixedPercent = total > 0 ? (fixedTotal / total * 100).toFixed(1) : 0;
            const variablePercent = total > 0 ? (variableTotal / total * 100).toFixed(1) : 0;

            let statusColor = 'var(--accent-green)';
            let statusText = 'Vynikaj√≠c√≠';
            if (fixedPercent > 60) { statusColor = 'var(--accent-red)'; statusText = 'P≈ô√≠li≈° vysok√©'; }
            else if (fixedPercent > 50) { statusColor = 'var(--warn)'; statusText = 'Na hranici'; }

            return `<div class="card" style="margin-top: 30px; border: 1px solid var(--accent-purple);">
                <h3 style="color: var(--accent-purple);">‚öñÔ∏è Pomƒõr fixn√≠ch vs variabiln√≠ch n√°klad≈Ø</h3>
                <p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom: 12px;">Anal√Ωza struktury va≈°ich trval√Ωch plateb (≈°ablon).</p>
                
                ${total > 0 ? `
                <div style="display: flex; height: 40px; border-radius: 12px; overflow: hidden; margin-bottom: 16px;">
                    <div style="width: ${fixedPercent}%; background: var(--accent-red); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.85rem;">
                        ${fixedPercent}%
                    </div>
                    <div style="width: ${variablePercent}%; background: var(--accent-green); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.85rem;">
                        ${variablePercent}%
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <div style="text-align: center; flex: 1;">
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">FIXN√ç N√ÅKLADY</div>
                        <div style="font-size: 1.4rem; font-weight: 900; color: var(--accent-red);">${formatMoney(fixedTotal)}</div>
                        <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 4px;">N√°jem, p≈Øjƒçky, poji≈°tƒõn√≠...</div>
                    </div>
                    <div style="text-align: center; flex: 1;">
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">VARIABILN√ç N√ÅKLADY</div>
                        <div style="font-size: 1.4rem; font-weight: 900; color: var(--accent-green);">${formatMoney(variableTotal)}</div>
                        <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 4px;">J√≠dlo, z√°bava, doprava...</div>
                    </div>
                </div>
                
                <div style="text-align: center; padding: 12px; background: var(--bg-subtle); border-radius: 12px; border: 1px solid ${statusColor};">
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Hodnocen√≠:</div>
                    <div style="font-size: 1.3rem; font-weight: 900; color: ${statusColor};">${statusText}</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">
                        ${fixedPercent <= 50 ? '‚úÖ Fixn√≠ n√°klady jsou pod 50% - ide√°ln√≠!' : '‚ö†Ô∏è Doporuƒçen√≠: Sni≈æte fixn√≠ n√°klady pod 50%'}
                    </div>
                </div>
                ` : `<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Nem√°te nastaveny trval√© platby v ≈°ablon√°ch.</p>`}
            </div>`;
        }

        // 7. Sc√©n√°≈ôov√° anal√Ωza
        function generateScenarioUI(monthlyExpense, currentCash) {
            return `<div class="card" style="margin-top: 30px; border: 1px solid var(--accent-purple);">
                <h3 style="color: var(--accent-purple);">üé≤ Sc√©n√°≈ôov√° anal√Ωza</h3>
                <p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom: 16px;">Co kdy≈æ p≈ôijde neƒçekan√° situace? Zvl√°dnete to?</p>
                
                <div class="form-group">
                    <label class="form-label">Sc√©n√°≈ô:</label>
                    <select id="scenarioType" class="form-select" onchange="updateScenarioInputs()">
                        <option value="jobLoss">Ztr√°ta zamƒõstn√°n√≠</option>
                        <option value="emergency">Neƒçekan√Ω v√Ωdaj</option>
                    </select>
                </div>
                
                <div id="scenarioJobLoss">
                    <div class="form-group">
                        <label class="form-label">Mƒõs√≠ce bez p≈ô√≠jmu</label>
                        <input type="number" id="scenarioMonths" class="form-input" value="3" min="1" inputmode="decimal">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mƒõs√≠ƒçn√≠ nutn√© v√Ωdaje (Kƒç)</label>
                        <input type="number" id="scenarioExpense" class="form-input" value="${monthlyExpense}" inputmode="decimal">
                    </div>
                </div>
                
                <div id="scenarioEmergency" style="display:none;">
                    <div class="form-group">
                        <label class="form-label">V√Ω≈°e neƒçekan√©ho v√Ωdaje (Kƒç)</label>
                        <input type="number" id="scenarioAmount" class="form-input" placeholder="Nap≈ô. 50000" inputmode="decimal">
                    </div>
                </div>
                
                <button class="btn btn-primary btn-block" style="margin-top: 12px; background: var(--accent-purple);" onclick="calculateScenario()">Analyzovat sc√©n√°≈ô</button>
                
                <div id="scenarioResultArea" style="display:none; margin-top: 20px; padding: 16px; background: var(--bg-subtle); border-radius: 12px;">
                    <div id="scenarioResult" style="text-align: center;"></div>
                </div>
            </div>`;
        }

        function updateScenarioInputs() {
            const type = document.getElementById('scenarioType').value;
            document.getElementById('scenarioJobLoss').style.display = type === 'jobLoss' ? 'block' : 'none';
            document.getElementById('scenarioEmergency').style.display = type === 'emergency' ? 'block' : 'none';
        }

        function calculateScenario() {
            const type = document.getElementById('scenarioType').value;
            const currentCash = AppState.balance;
            let resultHTML = '';

            if (type === 'jobLoss') {
                const months = parseFloat(document.getElementById('scenarioMonths').value) || 0;
                const expense = parseFloat(document.getElementById('scenarioExpense').value) || 0;
                const needed = months * expense;
                const remaining = currentCash - needed;
                
                if (remaining >= 0) {
                    resultHTML = `
                        <div style="font-size: 2.5rem; margin-bottom: 12px;">‚úÖ</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent-green); margin-bottom: 8px;">Zvl√°dnete to!</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Pot≈ôebujete: ${formatMoney(needed)}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">M√°te: ${formatMoney(currentCash)}</div>
                        <div style="font-size: 1.2rem; font-weight: 900; color: var(--accent-green); margin-top: 12px;">Zbyde v√°m: ${formatMoney(remaining)}</div>
                    `;
                } else {
                    resultHTML = `
                        <div style="font-size: 2.5rem; margin-bottom: 12px;">‚ö†Ô∏è</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent-red); margin-bottom: 8px;">Nedostateƒçn√° rezerva!</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Pot≈ôebujete: ${formatMoney(needed)}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">M√°te: ${formatMoney(currentCash)}</div>
                        <div style="font-size: 1.2rem; font-weight: 900; color: var(--accent-red); margin-top: 12px;">Chyb√≠: ${formatMoney(Math.abs(remaining))}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 12px;">üí° Doporuƒçujeme nav√Ω≈°it nouzov√Ω fond!</div>
                    `;
                }
            } else {
                const amount = parseFloat(document.getElementById('scenarioAmount').value) || 0;
                const remaining = currentCash - amount;
                
                if (amount === 0) { alert("Zadejte v√Ω≈°i neƒçekan√©ho v√Ωdaje."); return; }
                
                if (remaining >= 0) {
                    resultHTML = `
                        <div style="font-size: 2.5rem; margin-bottom: 12px;">‚úÖ</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent-green); margin-bottom: 8px;">Pokryjete to!</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Neƒçekan√Ω v√Ωdaj: ${formatMoney(amount)}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">V√°≈° z≈Østatek: ${formatMoney(currentCash)}</div>
                        <div style="font-size: 1.2rem; font-weight: 900; color: var(--accent-green); margin-top: 12px;">Zbyde v√°m: ${formatMoney(remaining)}</div>
                    `;
                } else {
                    resultHTML = `
                        <div style="font-size: 2.5rem; margin-bottom: 12px;">‚ùå</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent-red); margin-bottom: 8px;">Nepokryjete to!</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Neƒçekan√Ω v√Ωdaj: ${formatMoney(amount)}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">V√°≈° z≈Østatek: ${formatMoney(currentCash)}</div>
                        <div style="font-size: 1.2rem; font-weight: 900; color: var(--accent-red); margin-top: 12px;">Chyb√≠: ${formatMoney(Math.abs(remaining))}</div>
                    `;
                }
            }
            
            document.getElementById('scenarioResult').innerHTML = resultHTML;
            document.getElementById('scenarioResultArea').style.display = 'block';
        }

        // 8. Roƒçn√≠ forecast
        function generateForecastUI(income, expenses) {
            if (income === 0 || expenses === 0) return '';
            const monthlySurplus = income - expenses;
            
            return `<div class="card" style="margin-top: 30px; border: 1px solid var(--accent-purple);">
                <h3 style="color: var(--accent-purple);">üìÖ Roƒçn√≠ forecast</h3>
                <p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom: 16px;">Predikce va≈°eho z≈Østatku na z√°kladƒõ trval√Ωch p≈ô√≠jm≈Ø a v√Ωdaj≈Ø.</p>
                
                <div class="form-group">
                    <label class="form-label">Obdob√≠ forecastu:</label>
                    <select id="forecastPeriod" class="form-select" onchange="calculateForecast()">
                        <option value="3">3 mƒõs√≠ce</option>
                        <option value="6" selected>6 mƒõs√≠c≈Ø</option>
                        <option value="12">12 mƒõs√≠c≈Ø</option>
                    </select>
                </div>
                
                <div id="forecastResultArea" style="margin-top: 20px;">
                    <div style="padding: 16px; background: var(--bg-subtle); border-radius: 12px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 0.85rem; color: var(--text-secondary);">Souƒçasn√Ω z≈Østatek:</span>
                            <span style="font-weight: 700; color: var(--text-primary);">${formatMoney(AppState.balance)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 0.85rem; color: var(--text-secondary);">Mƒõs√≠ƒçn√≠ p≈ôebytek/deficit:</span>
                            <span style="font-weight: 700; color: ${monthlySurplus >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                                ${monthlySurplus >= 0 ? '+' : ''}${formatMoney(monthlySurplus)}
                            </span>
                        </div>
                    </div>
                    
                    <div id="forecastDetail" style="padding: 16px; background: var(--bg-subtle); border-radius: 12px; border: 1px solid var(--accent-purple);">
                        <div style="text-align: center;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">P≈ôedpokl√°dan√Ω z≈Østatek za <span id="forecastMonthsLabel">6</span> mƒõs√≠c≈Ø:</div>
                            <div id="forecastAmount" style="font-size: 2.2rem; font-weight: 900; margin: 12px 0;">0 Kƒç</div>
                            <div id="forecastDate" style="font-size: 0.8rem; color: var(--text-secondary);"></div>
                            <div id="forecastWarning" style="margin-top: 12px; font-size: 0.75rem;"></div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function calculateForecast() {
            const period = parseInt(document.getElementById('forecastPeriod').value) || 6;
            const monthlyIncome = AppState.templates.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const monthlyExpense = AppState.templates.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const monthlySurplus = monthlyIncome - monthlyExpense;
            
            const currentBalance = AppState.balance;
            const forecastBalance = currentBalance + (monthlySurplus * period);
            
            const futureDate = new Date();
            futureDate.setMonth(futureDate.getMonth() + period);
            
            document.getElementById('forecastMonthsLabel').textContent = period;
            document.getElementById('forecastAmount').textContent = formatMoney(forecastBalance);
            document.getElementById('forecastAmount').style.color = forecastBalance >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            document.getElementById('forecastDate').textContent = `(${futureDate.toLocaleDateString('cs-CZ', { month: 'long', year: 'numeric' })})`;
            
            let warningHTML = '';
            if (forecastBalance < 0) {
                warningHTML = `<div style="color: var(--accent-red); font-weight: 600;">‚ö†Ô∏è Pozor! P≈ôi souƒçasn√©m trendu budete v m√≠nusu!</div>`;
            } else if (forecastBalance < currentBalance) {
                warningHTML = `<div style="color: var(--warn); font-weight: 600;">‚ö†Ô∏è Z≈Østatek bude ni≈æ≈°√≠ ne≈æ nyn√≠.</div>`;
            } else {
                const increase = forecastBalance - currentBalance;
                warningHTML = `<div style="color: var(--accent-green); font-weight: 600;">‚úÖ Z≈Østatek naroste o ${formatMoney(increase)}</div>`;
            }
            document.getElementById('forecastWarning').innerHTML = warningHTML;
        }

        // Inicializace forecastu p≈ôi naƒçten√≠
        setTimeout(() => {
            if (document.getElementById('forecastPeriod')) {
                calculateForecast();
            }
        }, 500);



        function UI_runSimulatorClick() {
            const extraAnnualPayment = parseFloat(document.getElementById('simExtraPayment').value) || 0;
            const projection = calculateDebtProjection(extraAnnualPayment);
            renderTimeline(projection.timeline, projection.allMilestones);
            renderSimulationCharts(projection);
            document.getElementById('simResultsArea').style.display = 'block';
            document.getElementById('comparatorResultsArea').style.display = 'none';
        }
        function calculateDebtProjection(extraAnnualPayment) {
            let simLoans = JSON.parse(JSON.stringify(AppState.loans.filter(l => l.currentPrincipal > 1))).sort((a, b) => b.interestRate - a.interestRate);
            let monthlyData = []; let yearlyData = []; let timeline12Months = []; let allMilestones = [];
            let totalDebt = simLoans.reduce((sum, l) => sum + l.currentPrincipal, 0);
            let date = new Date();
            monthlyData.push({ date: new Date(date), balance: totalDebt });
            for (let m = 1; m <= 120; m++) {
                date.setMonth(date.getMonth() + 1);
                let monthStr = date.toLocaleDateString('cs-CZ', { month: 'long', year: 'numeric' });
                let loansFinishedThisMonth = [];
                simLoans.forEach(loan => {
                    if (loan.currentPrincipal > 0.1) {
                        let interest = loan.currentPrincipal * (loan.interestRate / 100 / 12);
                        let principalPart = loan.monthlyPayment - interest;
                        if (loan.currentPrincipal < principalPart) principalPart = loan.currentPrincipal;
                        loan.currentPrincipal -= principalPart;
                        if (loan.currentPrincipal <= 0.1) loansFinishedThisMonth.push(loan.name);
                    }
                });
                let targetLoan = simLoans.find(l => l.currentPrincipal > 0.1);
                let extraAppliedHere = 0;
                const isAnnualPaymentMonth = (m === 1 || (m - 1) % 12 === 0);
                if (targetLoan && extraAnnualPayment > 0 && isAnnualPaymentMonth) {
                    extraAppliedHere = Math.min(targetLoan.currentPrincipal, extraAnnualPayment);
                    targetLoan.currentPrincipal -= extraAppliedHere;
                    if (targetLoan.currentPrincipal <= 0.1 && !loansFinishedThisMonth.includes(targetLoan.name)) loansFinishedThisMonth.push(targetLoan.name);
                }
                loansFinishedThisMonth.forEach(name => { allMilestones.push({ dateStr: monthStr, text: `üéâ Doplacen √∫vƒõr: <b>${name}</b>!` }); });
                if (m <= 12) { timeline12Months.push({ monthStr: monthStr, isCurrent: (m === 1), targetName: targetLoan ? targetLoan.name : null, isAnnualPayment: (extraAppliedHere > 0), extraPaidAmount: extraAppliedHere, milestonesHere: loansFinishedThisMonth }); }
                totalDebt = simLoans.reduce((sum, l) => sum + Math.max(0, l.currentPrincipal), 0);
                if (m <= 36) monthlyData.push({ date: new Date(date), balance: Math.round(totalDebt) });
                if (m % 12 === 0 || totalDebt < 100) { let yearStr = date.getFullYear().toString(); if (!yearlyData.some(d => d.label === yearStr)) yearlyData.push({ label: yearStr, balance: Math.round(totalDebt) }); }
                if (totalDebt < 100) break;
            }
            return { monthly: monthlyData, yearly: yearlyData, timeline: timeline12Months, allMilestones: allMilestones };
        }
        function UI_runComparatorClick() {
            const extraAnnualPayment = parseFloat(document.getElementById('simExtraPayment').value) || 0;
            const avalancheResults = calculateGeneralizedProjection('avalanche', extraAnnualPayment);
            const snowballResults = calculateGeneralizedProjection('snowball', extraAnnualPayment);
            renderComparatorResults(avalancheResults, snowballResults);
            document.getElementById('comparatorResultsArea').style.display = 'block';
        }
        function calculateGeneralizedProjection(strategy, extraAnnualPayment) {
            let simLoans = JSON.parse(JSON.stringify(AppState.loans.filter(l => l.currentPrincipal > 1)));
            if (strategy === 'avalanche') { simLoans.sort((a, b) => b.interestRate - a.interestRate); } else { simLoans.sort((a, b) => a.currentPrincipal - b.currentPrincipal); }
            let totalDebt = simLoans.reduce((sum, l) => sum + l.currentPrincipal, 0);
            let totalInterestPaid = 0; let months = 0; let date = new Date();
            for (let m = 1; m <= 360; m++) {
                date.setMonth(date.getMonth() + 1); months++;
                simLoans.forEach(loan => {
                    if (loan.currentPrincipal > 0.1) {
                        let interest = loan.currentPrincipal * (loan.interestRate / 100 / 12); totalInterestPaid += interest;
                        let principalPart = loan.monthlyPayment - interest; if (loan.currentPrincipal < principalPart) principalPart = loan.currentPrincipal; loan.currentPrincipal -= principalPart;
                    }
                });
                let targetLoan = simLoans.find(l => l.currentPrincipal > 0.1);
                const isAnnualPaymentMonth = (m === 1 || (m - 1) % 12 === 0);
                if (targetLoan && extraAnnualPayment > 0 && isAnnualPaymentMonth) { let extraApplied = Math.min(targetLoan.currentPrincipal, extraAnnualPayment); targetLoan.currentPrincipal -= extraApplied; }
                totalDebt = simLoans.reduce((sum, l) => sum + Math.max(0, l.currentPrincipal), 0); if (totalDebt < 100) break;
            }
            const finalDateStr = date.toLocaleDateString('cs-CZ', { month: 'long', year: 'numeric' });
            return { months, finalDateStr, totalInterestPaid };
        }
        function renderComparatorResults(avalanche, snowball) {
            const container = document.getElementById('comparatorResultsArea');
            const interestDiff = snowball.totalInterestPaid - avalanche.totalInterestPaid;
            const isAvalancheWinner = interestDiff > 0;
            let summaryHtml = '';
            if (interestDiff > 100) { summaryHtml = `<div class="card" style="background: rgba(34, 197, 94, 0.1); border-color: var(--accent-green); padding: 16px; margin-bottom: 20px;"><h4 style="color: var(--accent-green); margin-bottom: 8px;">üí° Doporuƒçen√≠: Metoda Lavina</h4><p style="font-size: 0.9rem;">S metodou Lavina (hrazen√≠ nejdra≈æ≈°√≠ho dluhu) zaplat√≠te celkem o <b>${formatMoney(interestDiff)}</b> m√©nƒõ na √∫roc√≠ch ne≈æ s metodou Snƒõhov√° koule.</p></div>`; } else if (Math.abs(interestDiff) <= 100) { summaryHtml = `<div class="card" style="background: var(--bg-subtle); padding: 16px; margin-bottom: 20px;"><h4 style="margin-bottom: 8px;">üí° V√Ωsledek je t√©mƒõ≈ô shodn√Ω</h4><p style="font-size: 0.9rem;">Obƒõ metody vych√°zej√≠ finanƒçnƒõ velmi podobnƒõ. Zvolte tu, kter√° v√°m v√≠ce vyhovuje psychicky (Snƒõhov√° koule pro rychlej≈°√≠ pocit √∫spƒõchu z men≈°√≠ch dluh≈Ø).</p></div>`; }
            container.innerHTML = `${summaryHtml}<h3>Metoda Lavina (Nejvy≈°≈°√≠ √∫rok prvn√≠)</h3><div class="comparison-grid"><div class="comp-item ${isAvalancheWinner ? 'winner' : ''}"><div class="comp-label">Bez dluh≈Ø</div><div class="comp-val">${avalanche.finalDateStr}</div><div style="font-size:0.75rem; color:var(--text-secondary);">(${Math.round(avalanche.months/12*10)/10} let)</div></div><div class="comp-item ${isAvalancheWinner ? 'winner' : ''}"><div class="comp-label">Celkem √∫roky</div><div class="comp-val ${isAvalancheWinner ? 'good' : ''}">${formatMoney(avalanche.totalInterestPaid)}</div></div></div><h3 style="margin-top: 24px;">Metoda Snƒõhov√° koule (Nejni≈æ≈°√≠ z≈Østatek prvn√≠)</h3><div class="comparison-grid"><div class="comp-item ${!isAvalancheWinner && interestDiff < -100 ? 'winner' : ''}"><div class="comp-label">Bez dluh≈Ø</div><div class="comp-val">${snowball.finalDateStr}</div><div style="font-size:0.75rem; color:var(--text-secondary);">(${Math.round(snowball.months/12*10)/10} let)</div></div><div class="comp-item ${!isAvalancheWinner && interestDiff < -100 ? 'winner' : ''}"><div class="comp-label">Celkem √∫roky</div><div class="comp-val ${interestDiff > 100 ? 'bad' : ''}">${formatMoney(snowball.totalInterestPaid)}</div>${interestDiff > 100 ? `<div style="font-size:0.75rem; color:var(--accent-red);">(+${formatMoney(interestDiff)})</div>` : ''}</div></div>`;
        }
        function renderTimeline(timelineData, allMilestones) {
            const container = document.getElementById('simTimelineContainer'); container.innerHTML = '';
            if (timelineData.length === 0) { container.innerHTML = '<p style="color: var(--text-secondary);">≈Ω√°dn√© dluhy k ≈ôe≈°en√≠.</p>'; return; }
            timelineData.forEach((item, index) => {
                let actionText = '';
                if (item.targetName && item.isAnnualPayment) { actionText = `<span style="color: var(--accent-purple); font-weight: 700;">‚≠ê Roƒçn√≠ bonusov√Ω mƒõs√≠c!</span><br>Zapla≈•te minim√°ln√≠ spl√°tky. Nav√≠c po≈°lete roƒçn√≠ mimo≈ô√°dnou spl√°tku <b>${formatMoney(item.extraPaidAmount)}</b> na √∫vƒõr <b>"${item.targetName}"</b>.`; } else if (item.targetName) { actionText = `Pokraƒçujte v placen√≠ pouze minim√°ln√≠ch spl√°tek na v≈°echny √∫vƒõry.`; } else { actionText = `V≈°echny dluhy jsou splaceny!`; }
                let milestonesHtml = ''; item.milestonesHere.forEach(mName => { milestonesHtml += `<span class="milestone-badge">üéâ Doplacen: ${mName}</span>`; });
                const html = `<div class="timeline-item ${item.isCurrent ? 'current' : ''}" style="${item.isAnnualPayment ? 'border-left: 2px solid var(--accent-purple); padding-left: 12px; margin-left: -14px;' : ''}"><div class="timeline-marker" style="${item.isAnnualPayment ? 'background: var(--accent-purple); color: white; border-color: var(--accent-purple);' : ''}">${index + 1}</div><div class="timeline-content" style="${item.isAnnualPayment ? 'border-color: var(--accent-purple); background: rgba(168, 85, 247, 0.05);' : ''}"><div class="timeline-date">${item.monthStr} ${item.isCurrent ? '<span style="font-size:0.7rem; color:var(--accent-purple); margin-left:6px;">(Aktu√°ln√≠)</span>' : ''}</div><div class="timeline-action">${actionText}</div>${milestonesHtml}</div></div>`; container.innerHTML += html;
            });
            const futureMilestones = allMilestones.filter(m => !timelineData.some(t => t.monthStr === m.dateStr));
            if (futureMilestones.length > 0) { let futureHtml = `<div class="card" style="margin-top: 20px; background: rgba(168, 85, 247, 0.05); border-color: var(--accent-purple);"><h4>Budouc√≠ miln√≠ky</h4><ul style="padding-left: 20px; margin-top: 10px; color: var(--text-secondary);">`; futureMilestones.forEach(fm => { futureHtml += `<li style="margin-bottom: 6px;"><span style="font-weight:600; color:var(--text-primary);">${fm.dateStr}:</span> ${fm.text}</li>`; }); futureHtml += `</ul></div>`; container.innerHTML += futureHtml; }
        }
        function renderSimulationCharts(projection) {
            const ctxM = document.getElementById('simMonthlyChart').getContext('2d'); 
            if (payoffChartInstance) payoffChartInstance.destroy();
            payoffChartInstance = new Chart(ctxM, { 
                type: 'bar', 
                data: { 
                    labels: projection.monthly.map(d => `${d.date.getMonth()+1}/${d.date.getFullYear().toString().substr(-2)}`), 
                    datasets: [{ 
                        label: 'Z≈Østatek dluhu', 
                        data: projection.monthly.map(d => d.balance), 
                        backgroundColor: function(context) {
                            const chart = context.chart;
                            const {ctx, chartArea} = chart;
                            if (!chartArea) return '#a855f7';
                            const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                            gradient.addColorStop(0, 'rgba(168, 85, 247, 0.6)');
                            gradient.addColorStop(1, 'rgba(168, 85, 247, 1)');
                            return gradient;
                        },
                        borderRadius: 6,
                        borderSkipped: false
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { 
                            grid: { color: 'rgba(51, 51, 51, 0.5)', drawBorder: false }, 
                            ticks: { color: '#a0a0a0', font:{family:'Inter',size:10}, callback: v => v/1000 + 'k' } 
                        }, 
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: '#a0a0a0', font:{family:'Inter',size:9}, maxTicksLimit: 8 } 
                        } 
                    }, 
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { 
                            backgroundColor: 'rgba(18, 18, 18, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#a0a0a0',
                            borderColor: '#333',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: { label: c => formatMoney(c.parsed.y) } 
                        } 
                    } 
                } 
            });
            
            const ctxY = document.getElementById('simYearlyChart').getContext('2d'); 
            if (simYearlyChartInstance) simYearlyChartInstance.destroy();
            simYearlyChartInstance = new Chart(ctxY, { 
                type: 'bar', 
                data: { 
                    labels: projection.yearly.map(d => d.label), 
                    datasets: [{ 
                        label: 'Z≈Østek na konci roku', 
                        data: projection.yearly.map(d => d.balance), 
                        backgroundColor: function(context) {
                            const chart = context.chart;
                            const {ctx, chartArea} = chart;
                            if (!chartArea) return 'rgba(168, 85, 247, 0.6)';
                            const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                            gradient.addColorStop(0, 'rgba(168, 85, 247, 0.4)');
                            gradient.addColorStop(1, 'rgba(168, 85, 247, 0.8)');
                            return gradient;
                        },
                        borderRadius: 6,
                        borderSkipped: false
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { 
                            grid: { color: 'rgba(51, 51, 51, 0.5)', drawBorder: false }, 
                            ticks: { color: '#a0a0a0', font:{family:'Inter',size:10}, callback: v => v/1000 + 'k' } 
                        }, 
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: '#a0a0a0', font:{family:'Inter',size:10} } 
                        } 
                    }, 
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { 
                            backgroundColor: 'rgba(18, 18, 18, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#a0a0a0',
                            borderColor: '#333',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: { label: c => formatMoney(c.parsed.y) } 
                        } 
                    } 
                } 
            }); 
        }
        // ==================================================================================

        
        let trendChartInstance = null;
        
        function initTrendChart() {
            const yearSelect = document.getElementById('trendYear');
            const categorySelect = document.getElementById('trendCategory');
            
            if (!yearSelect || !categorySelect) return;
            
            // Z√≠sk√°me v≈°echny roky
            const years = new Set();
            AppState.transactions.forEach(t => {
                const year = new Date(t.date).getFullYear();
                years.add(year);
            });
            
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            yearSelect.innerHTML = '';
            
            // Pokud nem√°me ≈æ√°dn√© roky, p≈ôid√°me alespo≈à aktu√°ln√≠ rok
            if (sortedYears.length === 0) {
                const currentYear = new Date().getFullYear();
                yearSelect.innerHTML = `<option value="${currentYear}">${currentYear}</option>`;
            } else {
                sortedYears.forEach(year => {
                    yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
                });
                
                // Nastav√≠me aktu√°ln√≠ rok pokud existuje
                const currentYear = new Date().getFullYear();
                if (sortedYears.includes(currentYear)) {
                    yearSelect.value = currentYear;
                } else {
                    yearSelect.value = sortedYears[0];
                }
            }
            
            updateTrendCategorySelect();
            updateTrendChart();
        }
        
        function updateTrendCategorySelect() {
            const type = document.getElementById('trendType').value;
            const categorySelect = document.getElementById('trendCategory');
            
            categorySelect.innerHTML = '<option value="all">V≈°echny kategorie</option>';
            AppState.categories[type].forEach(cat => {
                categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }
        
        function updateTrendChart() {
            const type = document.getElementById('trendType').value;
            const year = parseInt(document.getElementById('trendYear').value);
            const category = document.getElementById('trendCategory').value;
            
            // Filtrujeme transakce
            const filtered = AppState.transactions.filter(t => {
                const tDate = new Date(t.date);
                const tYear = tDate.getFullYear();
                const matchType = t.type === type;
                const matchYear = tYear === year;
                const matchCategory = category === 'all' || t.category === category;
                return matchType && matchYear && matchCategory;
            });
            
            // Seskup√≠me podle mƒõs√≠c≈Ø
            const monthlyData = {};
            for (let m = 0; m < 12; m++) {
                monthlyData[m] = 0;
            }
            
            filtered.forEach(t => {
                const month = new Date(t.date).getMonth();
                monthlyData[month] += t.amount || 0;
            });
            
            const labels = ['Leden', '√önor', 'B≈ôezen', 'Duben', 'Kvƒõten', 'ƒåerven', 'ƒåervenec', 'Srpen', 'Z√°≈ô√≠', '≈ò√≠jen', 'Listopad', 'Prosinec'];
            const values = Object.values(monthlyData);
            
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (trendChartInstance) {
                trendChartInstance.destroy();
            }
            
            const color = type === 'income' ? '#22c55e' : '#ef4444';
            const bgColor = type === 'income' ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)';
            
            trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: type === 'income' ? 'P≈ô√≠jmy' : 'V√Ωdaje',
                        data: values,
                        borderColor: color,
                        backgroundColor: bgColor,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: color,
                        pointBorderColor: '#000',
                        pointBorderWidth: 2,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { 
                                color: 'rgba(51, 51, 51, 0.5)', 
                                drawBorder: false 
                            },
                            ticks: { 
                                color: '#a0a0a0', 
                                font: { family: 'Inter', size: 10 },
                                callback: function(value) {
                                    return value / 1000 + 'k';
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: '#a0a0a0', 
                                font: { family: 'Inter', size: 10 } 
                            }
                        }
                    },
                    plugins: {
                        legend: { 
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(18, 18, 18, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#a0a0a0',
                            borderColor: '#333',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatMoney(context.parsed.y);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Event listenery pro druh√Ω graf
        document.addEventListener('DOMContentLoaded', () => {
            const trendTypeSelect = document.getElementById('trendType');
            const trendYearSelect = document.getElementById('trendYear');
            const trendCategorySelect = document.getElementById('trendCategory');
            
            if (trendTypeSelect) {
                trendTypeSelect.addEventListener('change', () => {
                    updateTrendCategorySelect();
                    updateTrendChart();
                });
            }
            
            if (trendYearSelect) {
                trendYearSelect.addEventListener('change', updateTrendChart);
            }
            
            if (trendCategorySelect) {
                trendCategorySelect.addEventListener('change', updateTrendChart);
            }
            
            init();
        });
    </script>
</body>
</html>
